<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Student Portal | v4.33</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'pulse-slow': 'pulse 3s infinite', 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; color: #f8fafc; }
        .h-screen-dvh { height: 100vh; height: 100dvh; }
        [v-cloak] { display: none !important; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .offline-mask { backdrop-filter: blur(5px); background: rgba(15, 23, 42, 0.9); }
        .task-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(148, 163, 184, 0.1); }
        .task-locked { filter: grayscale(1); opacity: 0.6; pointer-events: none; background: rgba(15, 23, 42, 0.5); border-style: dashed; }
        .task-active { background: rgba(30, 41, 59, 0.9); transform: translateY(-2px); border-color: rgba(96, 165, 250, 0.5); }
        .task-done { background: rgba(6, 78, 59, 0.3); border-color: rgba(34, 197, 94, 0.5); opacity: 0.9; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #f8fafc; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        .theme-fire { --accent: #ef4444; --bg-glow: rgba(239, 68, 68, 0.15); }
        .theme-water { --accent: #3b82f6; --bg-glow: rgba(59, 130, 246, 0.15); }
        .theme-air { --accent: #fbbf24; --bg-glow: rgba(251, 191, 36, 0.15); }
        .theme-earth { --accent: #22c55e; --bg-glow: rgba(34, 197, 94, 0.15); }
        .beacon-border { border-color: var(--accent) !important; box-shadow: 0 0 15px var(--bg-glow); }
        .beacon-text { color: var(--accent) !important; }
        .beacon-bg { background-color: var(--bg-glow) !important; }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body class="overflow-hidden select-none">

<div id="app" v-cloak class="h-screen-dvh flex flex-col relative">
    
    <div class="fixed top-8 right-4 z-[99999] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="t in toasts" :key="t.id" class="pointer-events-auto px-4 py-3 rounded-xl shadow-lg border border-slate-700 bg-slate-800 text-white flex items-center gap-3 min-w-[300px] backdrop-blur-md">
                <i :class="t.icon" :class="t.type==='error'?'text-red-400':(t.type==='success'?'text-emerald-400':'text-blue-400')"></i>
                <div class="text-sm font-bold">{{ t.msg }}</div>
            </div>
        </transition-group>
    </div>

    <div v-if="!isOnline" class="fixed inset-0 z-[99999] offline-mask flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-slate-600">
            <i class="fa-solid fa-wifi text-5xl text-red-500 mb-6 animate-pulse"></i>
            <h3 class="text-2xl font-bold mb-2">è¨Šè™Ÿä¸­æ–·</h3>
            <p class="text-sm text-slate-400 font-mono">ç³»çµ±æ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š...</p>
        </div>
    </div>

    <div v-if="viewState === 'entry'" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-6 bg-slate-900">
        <div class="w-full max-w-sm glass-panel rounded-3xl p-8 shadow-2xl relative overflow-hidden border-t border-slate-600">
            <div class="relative z-10 text-center">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl text-white shadow-lg"><i class="fa-solid fa-graduation-cap"></i></div>
                <h1 class="text-3xl font-extrabold text-white mb-2">Student</h1>
                <p class="text-slate-400 text-xs font-mono mb-8">Secure Access v4.33</p>
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Session ID (æ•™å®¤ä»£ç¢¼)</label><input v-model="form.sessionId" class="w-full p-4 bg-slate-800 border border-slate-600 rounded-xl font-mono font-bold text-center text-xl text-white outline-none focus:border-blue-500 uppercase placeholder:text-slate-600" placeholder="è«‹è¼¸å…¥ä»£ç¢¼"></div>
                    <button @click="enterRoom" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition shadow-lg shadow-blue-900/30 disabled:opacity-50 flex justify-center items-center gap-2">
                        <span v-if="loading"><i class="fa-solid fa-circle-notch animate-spin"></i> é€£ç·šä¸­...</span>
                        <span v-else>é€²å…¥æ•™å®¤ <i class="fa-solid fa-arrow-right"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="viewState === 'roster'" class="flex flex-col h-full bg-slate-900">
        <div v-if="globalState.loginStatus === 'locked'" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 border border-slate-700">
                <i class="fa-solid fa-lock text-3xl text-red-500"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">åå–®å·²é–å®š</h2>
            <p class="text-slate-400">åŠ é€€é¸å·²çµæŸï¼Œç›®å‰ç¦æ­¢æ–°è¨­å‚™ç¶å®šã€‚<br>è‹¥æ‚¨æ˜¯æœ¬ç­å­¸ç”Ÿä¸”æ›´æ›äº†è£ç½®ï¼Œ<br>è«‹èˆ‰æ‰‹è«‹è€å¸«å”åŠ©è§£é–ã€‚</p>
            <button @click="attemptAutoLogin" class="mt-8 text-blue-400 hover:text-white underline text-sm">å˜—è©¦é‡æ–°é€£ç·š</button>
        </div>
        <div v-else class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-sm glass-panel p-8 rounded-3xl shadow-2xl relative border-t border-slate-600">
                <button @click="viewState='entry'" class="absolute top-4 left-4 text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="absolute top-4 right-4 text-[10px] font-mono font-bold text-slate-500 border border-slate-700 px-2 py-1 rounded bg-slate-900/50 tracking-widest">
                    {{ form.sessionId }}
                </div>
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white">èº«ä»½é©—è­‰</h2>
                    <p class="text-sm text-slate-400 mt-1">è«‹è¼¸å…¥æ‚¨çš„å­¸è™Ÿä»¥æŸ¥æ‰¾è³‡æ–™</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Student ID (å­¸è™Ÿ)</label>
                        <div class="relative">
                            <i class="fa-solid fa-id-card absolute left-4 top-4 text-slate-500"></i>
                            <input v-model="searchQuery" 
                                   @keyup.enter="handleSearch"
                                   class="w-full pl-12 p-4 bg-slate-800 border border-slate-600 rounded-xl font-mono font-bold text-lg text-white outline-none focus:border-blue-500 placeholder:text-slate-700 uppercase" 
                                   placeholder="ä¾‹å¦‚: S123456">
                        </div>
                    </div>

                    <button @click="handleSearch" :disabled="loading || !searchQuery" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition shadow-lg shadow-blue-900/30 disabled:opacity-50 flex justify-center items-center gap-2">
                        <span v-if="loading"><i class="fa-solid fa-circle-notch animate-spin"></i> æœå°‹ä¸­...</span>
                        <span v-else>ä¸‹ä¸€æ­¥ <i class="fa-solid fa-arrow-right"></i></span>
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <p class="text-[10px] text-slate-600">Secure Direct Lookup</p>
                </div>
            </div>
        </div>
    </div>

    <div v-if="claimingUser" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm glass-panel rounded-3xl p-6 relative animate-fade-in" :class="getBeaconClass(claimingUser.profile?.Zodiac)">
            <button @click="claimingUser=null" class="absolute top-4 right-4 text-slate-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-8 mt-2">
                <div class="w-20 h-20 mx-auto rounded-full beacon-bg flex items-center justify-center text-4xl beacon-text mb-4 border-2 beacon-border animate-pulse-slow shadow-[0_0_20px_rgba(255,255,255,0.1)]">{{ getZodiacIcon(claimingUser.profile?.Zodiac) }}</div>
                <h3 class="text-2xl font-bold text-white">{{ claimingUser.profile?.Name }}</h3>
                <p class="text-sm text-slate-400 font-mono mt-1">{{ claimingUser.profile?.StudentId }}</p>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-900/80 p-4 rounded-xl border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-500 uppercase flex justify-between mb-2"><span>è¨­å®š 4 ä½æ•¸ PIN ç¢¼</span><i class="fa-solid fa-lock"></i></label>
                    <input v-model="form.pin" type="tel" maxlength="4" class="w-full bg-transparent text-center text-3xl font-mono font-bold tracking-[0.5em] text-white outline-none placeholder:text-slate-700" placeholder="â€¢â€¢â€¢â€¢">
                </div>
                <button @click="executeAtomicClaim" :disabled="loading" class="w-full bg-white text-slate-900 py-4 rounded-xl font-bold shadow-lg transition active:scale-95 disabled:opacity-50 text-base">
                    <span v-if="loading"><i class="fa-solid fa-circle-notch animate-spin"></i> ç¶å®šä¸­...</span>
                    <span v-else>ç¢ºèªèº«ä»½</span>
                </button>
            </div>
        </div>
    </div>

    <div v-if="viewState === 'dashboard'" class="flex flex-col h-full w-full bg-slate-900 transition-colors duration-1000" :class="getBeaconClass(myProfile.zodiac?.label)">
        <nav class="glass-panel border-b border-white/10 h-16 flex-none relative z-50">
            <div class="container mx-auto px-4 h-full flex justify-between items-center max-w-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-lg border beacon-border beacon-bg beacon-text">{{ myProfile.zodiac?.icon }}</div>
                    <div>
                        <div class="font-bold text-white text-sm">{{ myProfile.name }}</div>
                        <div class="flex items-center gap-2">
                            <div class="text-[10px] text-slate-300 font-mono" v-if="myProfile.studentId">{{ myProfile.studentId }}</div>
                            <div class="w-px h-2 bg-slate-500/50" v-if="myProfile.studentId"></div>
                            <div class="text-[10px] beacon-text font-bold font-mono uppercase">Online</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden sm:block text-[10px] font-mono font-bold text-slate-500 border border-slate-700 px-2 py-1 rounded bg-slate-900/30 tracking-widest">
                        ID: {{ form.sessionId }}
                    </div>
                    <button @click="logout" class="text-slate-500 hover:text-white transition px-3 py-2"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <div v-if="globalProgress > 0" class="absolute bottom-0 left-0 w-full h-1 bg-slate-800"><div class="h-full bg-white/50 transition-all duration-1000" :style="`width:${globalProgress}%`"></div></div>
        </nav>

        <main class="flex-1 h-0 overflow-y-auto p-4 pb-32 scroll-smooth relative">
            <div class="container mx-auto max-w-md space-y-5">
                
                <div class="task-card p-5 rounded-2xl relative overflow-hidden" :class="myTasks.calibration.done ? 'task-done beacon-border' : 'bg-slate-800/80'">
                    <div class="flex gap-4 items-start relative z-10">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shrink-0 transition-colors" :class="myTasks.calibration.done ? 'beacon-bg beacon-text' : 'bg-slate-700 text-slate-400'"><i class="fa-solid fa-scale-balanced"></i></div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-white text-sm">Task 0: å­¸ç¿’ç‹€æ…‹æ ¡æº–</h3>
                            <div v-if="!myTasks.calibration.done" class="space-y-4 mt-3 p-4 bg-slate-900/80 rounded-xl border border-slate-700">
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs font-bold text-slate-400 uppercase"><span>æ‚¨å°æœ¬ä¸»é¡Œçš„ç†Ÿæ‚‰åº¦</span><span class="beacon-text text-base">{{ tempCalibration.confidence }}/5</span></div>
                                    <input type="range" v-model.number="tempCalibration.confidence" min="1" max="5" class="w-full accent-blue-500">
                                </div>
                                <button @click="submitCalibration" class="w-full bg-white text-slate-900 py-3 rounded-lg text-xs font-bold hover:bg-slate-200 transition">æäº¤ä¸¦è§£é–ä»»å‹™</button>
                            </div>
                            <div v-else class="text-xs font-bold beacon-text uppercase flex items-center gap-1 mt-2"><i class="fa-solid fa-check-circle"></i> å·²è¨­å®šåŸºæº–: Level {{ myTasks.calibration.confidence }}</div>
                        </div>
                    </div>
                </div>

                <div v-for="(task, key, idx) in mainTasks" :key="key" class="task-card p-5 rounded-2xl relative overflow-hidden" :class="getTaskClass(key)">
                    <div class="absolute right-2 top-2 opacity-5 text-6xl pointer-events-none transform rotate-12"><i :class="task.icon"></i></div>
                    <div class="flex gap-4 items-start relative z-10">
                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 transition-all duration-500 border border-transparent" :class="myTasks[key].done ? 'beacon-bg beacon-text shadow-lg scale-110 border-white/20' : (myTasks[key].started ? 'bg-blue-900/30 text-blue-400 border-blue-500/30' : 'bg-slate-800 text-slate-600')">
                            <i :class="myTasks[key].done ? 'fa-solid fa-check' : task.icon"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start"><h3 class="font-bold text-slate-100 text-base">{{ idx+1 }}. {{ task.title }}</h3></div>
                            <p class="text-xs text-slate-400 mb-4 mt-1 leading-relaxed">{{ task.desc }}</p>
                            <div v-if="isUnlocked(key)" class="flex flex-col gap-2 mt-2">
                                <button @click="openLink(key)" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-bold transition active:scale-95 border border-slate-600 hover:border-white text-slate-200 hover:bg-slate-800">
                                    <i v-if="myTasks[key].done" class="fa-solid fa-rotate-right"></i>
                                    <i v-else-if="key === 'assignment'" class="fa-brands fa-google-drive"></i>
                                    <i v-else class="fa-solid fa-arrow-up-right-from-square"></i>
                                    <span>
                                        {{ myTasks[key].done ? 'å†æ¬¡è¤‡ç¿’' : (key==='assignment' ? 'å‰å¾€ä¸Šå‚³å¿ƒå¾— (Google Form)' : 'é–‹å•Ÿæ•™æ/é€£çµ') }}
                                    </span>
                                </button>
                                <button v-if="myTasks[key].started && !myTasks[key].done" @click="markDone(key)" class="w-full bg-emerald-600 text-white px-4 py-3 rounded-xl text-sm font-bold hover:bg-emerald-500 transition active:scale-95 flex justify-center items-center gap-2 shadow-lg animate-pulse-slow">
                                    <i class="fa-regular fa-square-check text-lg"></i> {{ key==='assignment' ? 'æˆ‘å·²ä¸Šå‚³å®Œç•¢ï¼Œæ¨™è¨˜å®Œæˆ' : 'æ¨™è¨˜ç‚ºå·²å®Œæˆ' }}
                                </button>
                            </div>
                            <div v-else class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-900/50 text-slate-500 text-[10px] rounded-lg font-bold mt-2 border border-slate-700">
                                <i class="fa-solid fa-lock"></i> ç­‰å¾…è€å¸«é–‹æ”¾ (WAITING)
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="allTasksDone" class="bg-slate-800/90 p-6 rounded-2xl border border-white/10 mt-8 animate-fade-in relative overflow-hidden beacon-border shadow-2xl">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2 relative z-10 text-lg"><i class="fa-solid fa-flag-checkered beacon-text"></i> ä»»å‹™ç¸½çµ (Mission Debrief)</h3>
                    
                    <div v-if="!myProfile.rating || isEditing" class="space-y-6 relative z-10">
                        <div class="space-y-3">
                            <div class="flex justify-between text-xs font-bold text-slate-400 uppercase"><span>å­¸ç¿’æˆæ•ˆè‡ªè©•</span><span class="beacon-text text-xl">{{ tempRating }}</span></div>
                            <input type="range" v-model.number="tempRating" min="1" max="5" class="w-full accent-green-500">
                        </div>
                        <textarea v-model="tempFeedback" class="w-full p-4 bg-slate-900/80 border border-slate-600 rounded-xl text-sm text-white focus:border-white outline-none resize-none min-h-[100px]" placeholder="è«‹ç°¡çŸ­å¯«ä¸‹æ‚¨çš„å¿ƒå¾—æˆ–åæ€..."></textarea>
                        <button @click="submitDebrief" class="w-full bg-white text-slate-900 py-4 rounded-xl font-bold hover:scale-[1.02] transition shadow-xl text-base">
                            {{ myProfile.rating ? 'æ›´æ–°å¿ƒå¾— (Update)' : 'æäº¤ä¸¦çµæŸä»»å‹™' }}
                        </button>
                        <button v-if="myProfile.rating" @click="isEditing = false" class="w-full text-slate-400 text-xs py-2 hover:text-white transition">å–æ¶ˆä¿®æ”¹</button>
                    </div>

                    <div v-else class="text-center py-8 relative z-10">
                        <div class="text-5xl mb-4">ğŸ‰</div>
                        <div class="font-bold text-slate-200 text-xl">MISSION ACCOMPLISHED</div>
                        <div class="text-xs text-slate-500 mt-2">è³‡æ–™å·²åŒæ­¥è‡³æŒ‡æ®ä¸­å¿ƒ</div>
                        <button @click="isEditing = true" class="mt-6 px-4 py-2 border border-slate-600 rounded-lg text-xs text-slate-300 hover:bg-slate-700 hover:text-white transition flex items-center justify-center gap-2 mx-auto">
                            <i class="fa-solid fa-pen-to-square"></i> ä¿®æ”¹å¿ƒå¾—
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<script type="module">
import { createApp, reactive, ref, computed, onMounted, onUnmounted, watch } from 'https://unpkg.com/vue@3.4.19/dist/vue.esm-browser.prod.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, onValue, runTransaction, get, update, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const CONFIG = {
    FIREBASE: {
        apiKey: "AIzaSyBPdK2Ptbc9srt8DY74URKQyNmceexM-ro",
        authDomain: "cmu-11402-pathophysiology.firebaseapp.com",
        databaseURL: "https://cmu-11402-pathophysiology-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cmu-11402-pathophysiology",
        storageBucket: "cmu-11402-pathophysiology.firebasestorage.app",
        messagingSenderId: "367793212618",
        appId: "1:367793212618:web:c11acedc50ce6fc3897833",
        measurementId: "G-493SYB75VB"
    },
    ZODIAC: [
        {label:'å­é¼ ', icon:'âš¡ï¸', element:'air'}, {label:'ä¸‘ç‰›', icon:'ğŸ§±', element:'earth'}, {label:'å¯…è™', icon:'ğŸ”¥', element:'fire'}, {label:'å¯å…”', icon:'ğŸ§', element:'water'},
        {label:'è¾°é¾', icon:'ğŸŒŸ', element:'fire'}, {label:'å·³è›‡', icon:'ğŸ§ ', element:'water'}, {label:'åˆé¦¬', icon:'ğŸš€', element:'fire'}, {label:'æœªç¾Š', icon:'ğŸ¤', element:'earth'},
        {label:'ç”³çŒ´', icon:'ğŸ’¡', element:'air'}, {label:'é…‰é›', icon:'â±', element:'earth'}, {label:'æˆŒç‹—', icon:'ğŸ›¡', element:'earth'}, {label:'äº¥è±¬', icon:'ğŸ“š', element:'water'}
    ],
    TASKS_META: {
        notebook: { title: 'Gathering (çŸ¥è­˜ç²å–)', desc: 'é–±è®€æŒ‡å®šæ•™æï¼Œä¸¦ä½¿ç”¨ AI è¼”åŠ©æ•´ç†é‡é»ã€‚', icon: 'fa-solid fa-book-sparkles' },
        slido: { title: 'Briefing (äº’å‹•æå•)', desc: 'é€²å…¥ Slido èŠå¤©å®¤ï¼Œåƒèˆ‡æŠ•ç¥¨æˆ–æå‡ºå•é¡Œã€‚', icon: 'fa-solid fa-users-rays' },
        forms: { title: 'Assessment (æˆæ•ˆæª¢æ ¸)', desc: 'å®Œæˆæœ€çµ‚æ¸¬é©—ï¼Œé©—è­‰ä»Šæ—¥å­¸ç¿’æˆæœã€‚', icon: 'fa-solid fa-clipboard-check' },
        assignment: { title: 'Report (å¿ƒå¾—ç¹³äº¤)', desc: 'é»æ“Šé–‹å•Ÿ Google è¡¨å–®ï¼Œå¡«å¯«å­¸è™Ÿä¸¦ä¸Šå‚³æª”æ¡ˆ (Word/PDF/å½±åƒ)ã€‚', icon: 'fa-brands fa-google-drive' }
    }
};

const app = initializeApp(CONFIG.FIREBASE);
const db = getDatabase(app);

const sanitize = (str) => {
    if (!str) return '';
    return str.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]);
};
const getZodiacIcon = (label) => CONFIG.ZODIAC.find(z => z.label === label)?.icon || 'ğŸ‘¤';
const getBeaconClass = (label) => { const z = CONFIG.ZODIAC.find(x => x.label === label); return z ? `theme-${z.element}` : 'theme-earth'; };

function useSound() {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const playTone = (freq, type, duration, vol = 0.1) => {
        if (ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(vol, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + duration);
    };

    const playSFX = (type) => {
        switch (type) {
            case 'success':
                playTone(800, 'sine', 0.1, 0.1);
                setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 100);
                break;
            case 'error':
                playTone(150, 'sawtooth', 0.3, 0.15);
                setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.15), 100);
                break;
            case 'ping':
                playTone(1000, 'sine', 0.1, 0.05);
                break;
            case 'click':
                playTone(400, 'triangle', 0.05, 0.05);
                break;
            case 'boot':
                playTone(200, 'square', 0.1, 0.05);
                setTimeout(() => playTone(400, 'square', 0.1, 0.05), 100);
                setTimeout(() => playTone(800, 'square', 0.3, 0.05), 200);
                break;
        }
    };
    return { playSFX };
}

function useIdentity(sessionId, addToast, changeView, playSFX, globalState) {
    const loading = ref(false);
    const claimingUser = ref(null);
    const myProfile = reactive({ name: '', zodiac: null, uid: '', token: '', rating: 0, studentId: '' });

    const searchStudent = async (studentId) => {
        if (!studentId) { addToast("è«‹è¼¸å…¥å­¸è™Ÿ", "error"); return; }
        if (!sessionId.value) { addToast("æ•™å®¤ä»£ç¢¼ç„¡æ•ˆ", "error"); return; }
        
        loading.value = true;
        try {
            const targetId = studentId.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            const userRef = dbRef(db, `classrooms/${sessionId.value}/students/${targetId}`);
            
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.auth && userData.auth.isActive) {
                    addToast("âš ï¸ æ³¨æ„ï¼šæ­¤å¸³è™Ÿç›®å‰é¡¯ç¤ºç‚ºç·šä¸Šï¼Œç¹¼çºŒæ“ä½œå°‡å¼·åˆ¶ç™»å‡ºèˆŠè£ç½®", "info");
                }
                playSFX('click');
                claimingUser.value = { uid: targetId, ...userData };
            } else {
                addToast("æ‰¾ä¸åˆ°æ­¤å­¸è™Ÿï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢º", "error");
            }
        } catch (e) {
            console.error(e);
            addToast("æœå°‹å¤±æ•—: " + e.message, "error");
        } finally {
            loading.value = false;
        }
    };

    const executeClaim = async (pin) => {
        if(!pin || pin.length !== 4) { addToast("è«‹è¼¸å…¥ 4 ä½æ•¸ PIN ç¢¼", "error"); return; }
        
        if (globalState.loginStatus === 'locked') {
            addToast("â›” æ•™å®¤ç›®å‰ç¦æ­¢å…¥å ´ (LOCKED)", "error");
            claimingUser.value = null; 
            return;
        }

        loading.value = true;
        const targetUid = claimingUser.value.uid;
        const newDeviceToken = crypto.randomUUID();
        
        try {
            const result = await runTransaction(dbRef(db, `classrooms/${sessionId.value}/students/${targetUid}/auth`), (curr) => {
                return { 
                    isActive: true, 
                    pin, 
                    token: newDeviceToken, 
                    device: navigator.userAgent.slice(0, 30), 
                    claimedAt: Date.now() 
                };
            });

            if (result.committed) {
                const p = claimingUser.value.profile;
                const identity = { uid: targetUid, token: newDeviceToken, name: p.Name, zodiac: p.Zodiac, studentId: p.StudentId };
                localStorage.setItem('zodiac_identity', JSON.stringify(identity));
                myProfile.uid = targetUid; myProfile.token = newDeviceToken; myProfile.name = p.Name;
                myProfile.studentId = p.StudentId;
                myProfile.zodiac = CONFIG.ZODIAC.find(z => z.label === p.Zodiac);
                
                claimingUser.value = null;
                playSFX('success');
                changeView('dashboard');
                return true; 
            } else {
                addToast("ç³»çµ±ç¹å¿™ï¼Œè«‹å†è©¦ä¸€æ¬¡", "error");
                claimingUser.value = null;
                return false;
            }
        } catch(e) {
            addToast("é€£ç·šéŒ¯èª¤: "+e.message, "error");
            return false;
        } finally { loading.value = false; }
    };

    const attemptAutoLogin = async () => {
        const stored = localStorage.getItem('zodiac_identity');
        if(!stored) { changeView('roster'); return false; }
        
        loading.value = true;
        try {
            const localId = JSON.parse(stored);
            const authSnap = await get(dbRef(db, `classrooms/${sessionId.value}/students/${localId.uid}/auth`));
            
            if(authSnap.exists() && authSnap.val().token === localId.token) {
                update(dbRef(db, `classrooms/${sessionId.value}/students/${localId.uid}/auth`), { isActive: true });
                
                myProfile.uid = localId.uid; myProfile.token = localId.token; myProfile.name = localId.name;
                myProfile.studentId = localId.studentId || '';
                myProfile.zodiac = CONFIG.ZODIAC.find(z => z.label === localId.zodiac);
                changeView('dashboard');
                return true;
            } else {
                localStorage.removeItem('zodiac_identity');
                addToast("æ‚¨çš„èº«ä»½å·²å¤±æ•ˆæˆ–è¢«å¼·åˆ¶ç™»å‡º", "error");
                changeView('roster');
                return false;
            }
        } catch(e) { 
            changeView('roster'); return false; 
        } finally { loading.value = false; }
    };

    return { 
        loading, claimingUser, myProfile, 
        searchStudent, executeClaim, attemptAutoLogin,
        logout: async () => { 
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿé€™å°‡è§£é™¤èˆ‡æ­¤èº«ä»½çš„ç¶å®šã€‚")) {
                if(myProfile.uid && sessionId.value) {
                    try {
                        await update(dbRef(db, `classrooms/${sessionId.value}/students/${myProfile.uid}/auth`), { isActive: false, token: null });
                    } catch(e) { console.error("Logout sync failed", e); }
                }
                localStorage.removeItem('zodiac_identity'); 
                location.reload(); 
            }
        }
    };
}

function useRoom(sessionId, myUid) {
    const isOnline = ref(navigator.onLine);
    const globalState = reactive({ currentPhase: 'waiting', links: {}, globalProgress: 0, loginStatus: 'open' });
    
    const initConnection = () => {
        window.addEventListener('online', () => isOnline.value = true);
        window.addEventListener('offline', () => isOnline.value = false);
        onValue(dbRef(db, ".info/connected"), (snap) => isOnline.value = snap.val() === true);
    };

    const startHeartbeat = () => {
        const userRef = dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`);
        
        onDisconnect(userRef).update({ 
            status: 'offline',
            'auth/isActive': false 
        });

        const sendPulse = () => {
            if (navigator.onLine && document.visibilityState === 'visible' && myUid.value) {
                update(userRef, { lastSeen: Date.now(), status: 'online' });
            }
        };

        sendPulse();
        const timer = setInterval(sendPulse, 10000);
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') sendPulse(); });

        return () => clearInterval(timer);
    };

    const initRoomSync = () => {
        onValue(dbRef(db, `classrooms/${sessionId.value}/status`), (snap) => {
            if(snap.exists()) Object.assign(globalState, snap.val());
        });
    };

    return { isOnline, globalState, initConnection, startHeartbeat, initRoomSync };
}

function useTasks(sessionId, myUid, globalState, myProfile, addToast, playSFX) {
    const myTasks = reactive({ 
        calibration: { done: false, confidence: 3 }, 
        notebook: { done: false, started: false }, 
        slido: { done: false, started: false }, 
        forms: { done: false, started: false },
        assignment: { done: false, started: false }
    });
    const tempCalibration = reactive({ confidence: 3, hasPreview: false });
    const tempRating = ref(3);
    const tempFeedback = ref('');
    const isEditing = ref(false); 

    const initTaskSync = () => {
        const userRef = dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`);
        onValue(userRef, (snap) => {
            const val = snap.val();
            if(!val || (val.auth && !val.auth.isActive)) {
                localStorage.removeItem('zodiac_identity');
                alert("â›” é€£ç·šä¸­æ–·\næ‚¨çš„èº«ä»½å·²è¢«ç®¡ç†å“¡æ’¤éŠ·ã€‚");
                window.location.reload();
                return;
            }
            if(val.tasks) Object.assign(myTasks, val.tasks);
            if(val.rating) myProfile.rating = val.rating;
            if(val.feedback) tempFeedback.value = val.feedback;
            if(val.rating) tempRating.value = val.rating;
        });
    };

    const submitCalibration = () => {
        if (!myUid.value || !sessionId.value) { addToast("é€£ç·šè³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ", "error"); return; }
        const now = Date.now();
        const fakeStartTime = now - 6000;
        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/calibration`), { 
            done: true, 
            confidence: tempCalibration.confidence, 
            hasPreview: tempCalibration.hasPreview || false,
            startTime: fakeStartTime,
            endTime: now,
            duration: 6 
        }).then(() => playSFX('success')).catch(e => addToast("æ ¡æº–å¤±æ•—: " + e.message, "error"));
    };

    const openLink = (k) => {
        playSFX('click');
        if(!myTasks[k].started) { 
            update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/${k}`), { started: true, startTime: Date.now() }); 
        }
        setTimeout(() => {
            let url = globalState.links && globalState.links[k];
            if (url) {
                if (k === 'assignment' && url.includes('forms') && myProfile.studentId) {
                }
                window.open(url, '_blank');
            }
        }, 100);
    };

    const markDone = (k) => {
        if (!myUid.value || !sessionId.value) { addToast("é€£ç·šè³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ", "error"); return; }
        const now = Date.now();
        let startTime = myTasks[k].startTime || (now - 10000); 
        let duration = Math.round((now - startTime) / 1000);
        if (isNaN(duration) || duration < 0) duration = 10; 
        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/${k}`), { 
            done: true, endTime: now, duration: duration, startTime: startTime 
        }).then(() => playSFX('success')).catch(e => addToast("æ›´æ–°å¤±æ•—: " + e.message, "error"));
    };

    const submitDebrief = () => {
        const cleanFeedback = sanitize(tempFeedback.value);
        if(cleanFeedback.length < 2) { addToast("è«‹å¡«å¯«è‡³å°‘å¹¾å€‹å­—çš„å¿ƒå¾—", "error"); return; }
        playSFX('success');
        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`), { rating: tempRating.value, feedback: cleanFeedback });
        addToast(myProfile.rating ? "å¿ƒå¾—å·²æ›´æ–°ï¼" : "å¿ƒå¾—å·²æäº¤ï¼Œæ„Ÿè¬æ‚¨çš„å›é¥‹ï¼", "success");
        isEditing.value = false;
    };

    const isUnlocked = (k) => {
        if (!myTasks.calibration.done) return false;
        
        const rawPhase = globalState.currentPhase || 'waiting';
        const p = String(rawPhase).toLowerCase(); 

        const isMainPhase = ['warmup', 'interact', 'quiz', 'all_open'].some(x => p.includes(x));
        
        if (k === 'notebook') return isMainPhase;
        
        if (k === 'slido') return ['interact', 'all_open'].some(x => p.includes(x));
        
        if (k === 'forms') return ['quiz', 'all_open'].some(x => p.includes(x));
        
        if (k === 'assignment') return p.includes('assignment') || p.includes('report');
        
        return false;
    };

    return { myTasks, tempCalibration, tempRating, tempFeedback, initTaskSync, submitCalibration, openLink, markDone, submitDebrief, isUnlocked, isEditing };
}

createApp({
    setup() {
        const form = reactive({ sessionId: '', pin: '' });
        const viewState = ref('entry');
        const toasts = ref([]);
        const searchQuery = ref('');

        const sessionRef = computed(() => form.sessionId);
        const changeView = (v) => viewState.value = v;

        const { playSFX } = useSound();

        const addToast = (msg, type = 'info') => {
            const id = Date.now();
            let icon = 'fa-solid fa-circle-info';
            if(type === 'success') icon = 'fa-solid fa-circle-check';
            if(type === 'error') icon = 'fa-solid fa-circle-exclamation';
            toasts.value.push({ id, msg, type, icon });
            
            setTimeout(() => {
                const idx = toasts.value.findIndex(t => t.id === id);
                if (idx !== -1) toasts.value.splice(idx, 1);
            }, 3000);
        };

        watch(() => toasts.value.length, (newLen, oldLen) => {
            if (newLen > oldLen) {
                const latest = toasts.value[toasts.value.length - 1];
                if (latest.type === 'error') playSFX('error');
                else if (latest.type === 'success') playSFX('success');
                else playSFX('ping');
            }
        });

        const myProfileRef = reactive({ uid: '', name: '', zodiac: null });
        const myUidRef = computed(() => myProfileRef.uid);
        const { isOnline, globalState, initConnection, startHeartbeat, initRoomSync } = useRoom(sessionRef, myUidRef);
        
        const { loading, claimingUser, myProfile, executeClaim, attemptAutoLogin, searchStudent, logout } = useIdentity(sessionRef, addToast, changeView, playSFX, globalState);
        
        watch(myProfile, (newP) => Object.assign(myProfileRef, newP));

        const { myTasks, tempCalibration, tempRating, tempFeedback, initTaskSync, submitCalibration, openLink, markDone, submitDebrief, isUnlocked, isEditing } = useTasks(sessionRef, myUidRef, globalState, myProfile, addToast, playSFX);

        onMounted(() => {
            const pid = new URLSearchParams(window.location.search).get('id');
            if(pid) { 
                form.sessionId = pid; 
                setTimeout(() => attemptAutoLogin().then(success => { if(success) startDashboardServices(); }), 100);
            }
            initConnection();
        });

        const startDashboardServices = () => {
            initRoomSync();
            initTaskSync();
            startHeartbeat();
        };

        const enterRoom = () => {
            playSFX('boot');
            if(!form.sessionId) { addToast("è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼", "error"); return; }
            attemptAutoLogin().then(success => {
                if(success) startDashboardServices();
            });
        };

        const executeAtomicClaim = async () => {
            playSFX('click');
            const success = await executeClaim(form.pin);
            if(success) startDashboardServices();
        };
        
        // ä¿®æ”¹å¾Œçš„åˆ¤æ–·é‚è¼¯ï¼šå®Œæˆ (1+2+3) æˆ–è€… (4) çš†å¯
        const allTasksDone = computed(() => {
            const regular = myTasks.notebook.done && myTasks.slido.done && myTasks.forms.done;
            const assignment = myTasks.assignment.done;
            return regular || assignment;
        });
        
        const getTaskClass = (k) => {
            if (myTasks[k].done) return 'task-done beacon-border';
            if (myTasks[k].started) return 'task-active beacon-ring ring-1';
            if (!isUnlocked(k)) return 'task-locked';
            return 'bg-slate-800/50 border-slate-700';
        };

        const handleSearch = () => {
            searchStudent(searchQuery.value);
        };

        return {
            form, viewState, loading, toasts, searchQuery, isOnline,
            claimingUser, myProfile, globalState, tempCalibration, tempRating, tempFeedback,
            enterRoom, handleSearch, executeAtomicClaim, logout,
            submitCalibration, openLink, markDone, submitDebrief, forceReload: ()=>location.reload(),
            getZodiacIcon, getBeaconClass, getTaskClass, isUnlocked, allTasksDone, 
            globalProgress: computed(()=>globalState.globalProgress),
            mainTasks: CONFIG.TASKS_META, myTasks,
            playSFX,
            isEditing
        };
    }
}).mount('#app');
</script>
</body>
</html>