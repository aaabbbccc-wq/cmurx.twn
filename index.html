<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Student Portal | v4.9 Dual-Track</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'pulse-slow': 'pulse 3s infinite', 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; color: #f8fafc; }
        .h-screen-dvh { height: 100vh; height: 100dvh; }
        [v-cloak] { display: none !important; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .offline-mask { backdrop-filter: blur(5px); background: rgba(15, 23, 42, 0.9); }
        
        .task-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; background: rgba(30, 41, 59, 0.4); }
        .task-locked { filter: grayscale(1); opacity: 0.5; pointer-events: none; background: rgba(15, 23, 42, 0.3); border: 1px dashed rgba(71, 85, 105, 0.3); }
        .task-active { background: rgba(30, 41, 59, 0.95); transform: translateY(-2px); border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15); }
        .task-done { background: rgba(6, 78, 59, 0.2); border-color: rgba(34, 197, 94, 0.4); opacity: 1; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #f8fafc; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        .theme-fire { --accent: #ef4444; --bg-glow: rgba(239, 68, 68, 0.15); }
        .theme-water { --accent: #3b82f6; --bg-glow: rgba(59, 130, 246, 0.15); }
        .theme-air { --accent: #fbbf24; --bg-glow: rgba(251, 191, 36, 0.15); }
        .theme-earth { --accent: #22c55e; --bg-glow: rgba(34, 197, 94, 0.15); }
        
        .theme-secret { --accent: #94a3b8; --bg-glow: rgba(148, 163, 184, 0.1); } 

        .beacon-border { border-color: var(--accent) !important; box-shadow: 0 0 15px var(--bg-glow); }
        .beacon-text { color: var(--accent) !important; }
        .beacon-bg { background-color: var(--bg-glow) !important; }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body class="overflow-hidden select-none">

<div id="app" v-cloak class="h-screen-dvh flex flex-col relative">
    
    <div class="fixed top-8 right-4 z-[99999] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="t in toasts" :key="t.id" class="pointer-events-auto px-4 py-3 rounded-xl shadow-lg border border-slate-700 bg-slate-800 text-white flex items-center gap-3 min-w-[300px] backdrop-blur-md">
                <i :class="t.icon" :class="t.type==='error'?'text-red-400':(t.type==='success'?'text-emerald-400':'text-blue-400')"></i>
                <div class="text-sm font-bold">{{ t.msg }}</div>
            </div>
        </transition-group>
    </div>

    <div v-if="!isOnline" class="fixed inset-0 z-[99999] offline-mask flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-slate-600">
            <i class="fa-solid fa-wifi text-5xl text-red-500 mb-6 animate-pulse"></i>
            <h3 class="text-2xl font-bold mb-2">è¨Šè™Ÿä¸­æ–·</h3>
            <p class="text-sm text-slate-400 font-mono">ç³»çµ±æ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š...</p>
        </div>
    </div>

    <div v-if="viewState === 'entry'" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-6 bg-slate-900">
        <div class="w-full max-w-sm glass-panel rounded-3xl p-8 shadow-2xl relative overflow-hidden border-t border-slate-600">
            <div class="relative z-10 text-center">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl text-white shadow-lg"><i class="fa-solid fa-graduation-cap"></i></div>
                <h1 class="text-3xl font-extrabold text-white mb-2">Student</h1>
                <p class="text-slate-400 text-xs font-mono mb-8">Secure Access v4.9 (Smart)</p>
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Session ID</label><input v-model="form.sessionId" class="w-full p-4 bg-slate-800 border border-slate-600 rounded-xl font-mono font-bold text-center text-xl text-white outline-none focus:border-blue-500 uppercase placeholder:text-slate-600" placeholder="æ•™å®¤ä»£ç¢¼"></div>
                    <button @click="enterRoom" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition shadow-lg shadow-blue-900/30 disabled:opacity-50 flex justify-center items-center gap-2">
                        <span v-if="loading"><i class="fa-solid fa-circle-notch animate-spin"></i> é€£ç·šä¸­...</span>
                        <span v-else>é€²å…¥æ•™å®¤ <i class="fa-solid fa-arrow-right"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="viewState === 'roster'" class="flex flex-col h-full bg-slate-900">
        <div v-if="globalState.loginStatus === 'locked'" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 border border-slate-700">
                <i class="fa-solid fa-lock text-3xl text-red-500"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">åå–®å·²é–å®š</h2>
            <p class="text-slate-400">è«‹èˆ‰æ‰‹è«‹è€å¸«å”åŠ©è§£é–ã€‚</p>
            <button @click="attemptAutoLogin" class="mt-8 text-blue-400 hover:text-white underline text-sm">é‡æ–°å˜—è©¦</button>
        </div>
        <div v-else class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-sm glass-panel p-8 rounded-3xl shadow-2xl relative border-t border-slate-600">
                <button @click="viewState='entry'" class="absolute top-4 left-4 text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white">èº«ä»½é©—è­‰</h2>
                    <p class="text-sm text-slate-400 mt-1">Direct Lookup</p>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <i class="fa-solid fa-id-card absolute left-4 top-4 text-slate-500"></i>
                        <input v-model="searchQuery" @keyup.enter="handleSearch" class="w-full pl-12 p-4 bg-slate-800 border border-slate-600 rounded-xl font-mono font-bold text-lg text-white outline-none focus:border-blue-500 uppercase" placeholder="å­¸è™Ÿ (å¦‚ S12345)">
                    </div>
                    <button @click="handleSearch" :disabled="loading || !searchQuery" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition shadow-lg flex justify-center items-center gap-2">
                        <span v-if="loading"><i class="fa-solid fa-circle-notch animate-spin"></i></span>
                        <span v-else>ä¸‹ä¸€æ­¥ <i class="fa-solid fa-arrow-right"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="claimingUser" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm glass-panel rounded-3xl p-6 relative animate-fade-in" :class="getBeaconClass(claimingUser.profile?.Zodiac)">
            <button @click="claimingUser=null" class="absolute top-4 right-4 text-slate-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-8 mt-2">
                <div class="w-20 h-20 mx-auto rounded-full beacon-bg flex items-center justify-center text-4xl beacon-text mb-4 border-2 beacon-border animate-pulse-slow">
                    {{ isGroupRevealed ? getZodiacIcon(claimingUser.profile?.Zodiac) : 'â“' }}
                </div>
                <h3 class="text-2xl font-bold text-white">{{ claimingUser.profile?.Name }}</h3>
                <p class="text-sm text-slate-400 font-mono mt-1">
                    {{ claimingUser.profile?.StudentId }}
                    <span v-if="isGroupRevealed"> | {{ claimingUser.profile?.Zodiac }}</span>
                </p>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-900/80 p-4 rounded-xl border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-500 uppercase flex justify-between mb-2"><span>PIN Code</span><i class="fa-solid fa-lock"></i></label>
                    <input v-model="form.pin" type="tel" maxlength="4" class="w-full bg-transparent text-center text-3xl font-mono font-bold tracking-[0.5em] text-white outline-none placeholder:text-slate-700" placeholder="â€¢â€¢â€¢â€¢">
                </div>
                <button @click="executeAtomicClaim" :disabled="loading" class="w-full bg-white text-slate-900 py-4 rounded-xl font-bold shadow-lg transition active:scale-95 disabled:opacity-50 text-base">
                    ç¢ºèªèº«ä»½
                </button>
            </div>
        </div>
    </div>

    <div v-if="viewState === 'dashboard'" class="flex flex-col h-full w-full bg-slate-900 transition-colors duration-1000" :class="getBeaconClass(myProfile.zodiac?.label)">
        <nav class="glass-panel border-b border-white/10 h-16 flex-none relative z-50">
            <div class="container mx-auto px-4 h-full flex justify-between items-center max-w-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-lg border beacon-border beacon-bg beacon-text">
                        {{ getCurrentIcon() }}
                    </div>
                    <div>
                        <div class="font-bold text-white text-sm">{{ myProfile.name }}</div>
                        <div class="flex items-center gap-2">
                            <div class="text-[10px] text-slate-300 font-mono" v-if="myProfile.studentId">{{ myProfile.studentId }}</div>
                            <div class="w-px h-2 bg-slate-500/50"></div>
                            <div class="text-[10px] beacon-text font-bold font-mono uppercase">
                                {{ isGroupRevealed ? myProfile.zodiac?.label : 'Waiting...' }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden sm:block text-[10px] font-mono font-bold text-slate-500 border border-slate-700 px-2 py-1 rounded bg-slate-900/30 tracking-widest">
                        ID: {{ form.sessionId }}
                    </div>
                    <button @click="logout" class="text-slate-500 hover:text-white transition px-3 py-2"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <div v-if="globalProgress > 0" class="absolute bottom-0 left-0 w-full h-1 bg-slate-800"><div class="h-full bg-white/50 transition-all duration-1000" :style="`width:${globalProgress}%`"></div></div>
        </nav>

        <main class="flex-1 h-0 overflow-y-auto p-4 pb-32 scroll-smooth relative">
            <div class="container mx-auto max-w-md space-y-5">
                
                <div class="task-card p-5 rounded-2xl relative overflow-hidden bg-slate-800/50" :class="getTaskClass('calibration')">
                    <div class="flex gap-4 items-start relative z-10">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shrink-0 transition-colors bg-slate-700 text-slate-400" :class="{'beacon-bg beacon-text': myTasks.calibration.done}"><i class="fa-solid fa-scale-balanced"></i></div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-white text-sm">æš–èº«æ ¡æº–</h3>
                            <div v-if="!myTasks.calibration.done" class="space-y-4 mt-3 p-4 bg-slate-900/80 rounded-xl border border-slate-700">
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs font-bold text-slate-400 uppercase"><span>æ‚¨å°æœ¬ä¸»é¡Œçš„ç†Ÿæ‚‰åº¦</span><span class="beacon-text text-base">{{ tempCalibration.confidence }}/5</span></div>
                                    <input type="range" v-model.number="tempCalibration.confidence" min="1" max="5" class="w-full accent-blue-500">
                                </div>
                                <button @click="submitCalibration" class="w-full bg-white text-slate-900 py-3 rounded-lg text-xs font-bold hover:bg-slate-200 transition">æäº¤ä¸¦è§£é–ä»»å‹™</button>
                            </div>
                            <div v-else class="text-xs font-bold beacon-text uppercase flex items-center gap-1 mt-2"><i class="fa-solid fa-check-circle"></i> å·²å®Œæˆè¨­å®š (Level {{ myTasks.calibration.confidence }})</div>
                        </div>
                    </div>
                </div>

                <div v-if="globalState.config?.enableGroupA">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-3 mt-2 pl-1 tracking-widest">Group A: å­¸ç¿’æ ¸å¿ƒ (Input)</div>
                    
                    <div v-for="key in ['notebook', 'slido', 'forms']" :key="key" class="task-card p-5 rounded-2xl relative overflow-hidden mb-4 bg-slate-800/30" :class="getTaskClass(key)">
                        <div class="flex gap-4 items-start relative z-10">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 transition-all duration-500 border border-transparent" 
                                 :class="myTasks[key].done ? 'beacon-bg beacon-text shadow-lg scale-110 border-white/20' : (myTasks[key].started ? 'bg-blue-900/30 text-blue-400 border-blue-500/30' : 'bg-slate-800 text-slate-600')">
                                <i :class="myTasks[key].done ? 'fa-solid fa-check' : mainTasks[key].icon"></i>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-slate-100 text-base">{{ mainTasks[key].title }}</h3>
                                <p class="text-xs text-slate-400 mb-4 mt-1 leading-relaxed">{{ mainTasks[key].desc }}</p>
                                
                                <div v-if="isUnlocked(key)" class="flex flex-col gap-2 mt-2">
                                    <button @click="openLink(key)" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-bold transition active:scale-95 border border-slate-600 hover:border-white text-slate-200 hover:bg-slate-800">
                                        <i class="fa-solid fa-arrow-up-right-from-square"></i> {{ myTasks[key].done ? 'å†æ¬¡è¤‡ç¿’' : 'é–‹å•Ÿé€£çµ' }}
                                    </button>
                                    <button v-if="myTasks[key].started && !myTasks[key].done" @click="markDone(key)" class="w-full bg-white text-slate-900 px-4 py-3 rounded-xl text-sm font-bold hover:bg-slate-200 transition active:scale-95 flex justify-center items-center gap-2 shadow-lg animate-pulse-slow">
                                        <i class="fa-regular fa-square-check text-lg"></i> æ¨™è¨˜å®Œæˆ
                                    </button>
                                </div>
                                <div v-else class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-900/50 text-slate-500 text-[10px] rounded-lg font-bold mt-2 border border-slate-700">
                                    <i class="fa-solid fa-lock"></i> ç­‰å¾…é–‹æ”¾
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="groupADone" class="bg-slate-800/90 p-6 rounded-2xl border border-white/10 mt-2 mb-8 animate-fade-in relative overflow-hidden beacon-border shadow-2xl">
                        <h3 class="font-bold text-white mb-4 flex items-center gap-2 relative z-10 text-lg"><i class="fa-solid fa-lightbulb beacon-text"></i> å­¸ç¿’åæ€ (Debrief)</h3>
                        <div v-if="!myProfile.rating || isEditing" class="space-y-6 relative z-10">
                            <div class="space-y-3">
                                <div class="flex justify-between text-xs font-bold text-slate-400 uppercase"><span>å­¸ç¿’æˆæ•ˆè‡ªè©•</span><span class="beacon-text text-xl">{{ tempRating }}</span></div>
                                <input type="range" v-model.number="tempRating" min="1" max="5" class="w-full accent-green-500">
                            </div>
                            <textarea v-model="tempFeedback" class="w-full p-4 bg-slate-900/80 border border-slate-600 rounded-xl text-sm text-white focus:border-white outline-none resize-none min-h-[100px]" placeholder="æ€è€ƒä¸€ä¸‹ï¼šæœ¬å–®å…ƒæœ€æ ¸å¿ƒçš„æ¦‚å¿µæ˜¯ä»€éº¼ï¼Ÿ"></textarea>
                            <button @click="submitDebrief" class="w-full bg-white text-slate-900 py-4 rounded-xl font-bold hover:scale-[1.02] transition shadow-xl text-base">æäº¤åæ€</button>
                        </div>
                        <div v-else class="text-center py-6 relative z-10">
                            <div class="text-3xl mb-2">âœ¨</div>
                            <div class="text-sm text-slate-300">åæ€å·²æäº¤</div>
                            <button @click="isEditing = true" class="mt-4 text-xs text-slate-500 underline">ä¿®æ”¹å…§å®¹</button>
                        </div>
                    </div>
                </div>

                <div v-if="globalState.config?.enableGroupB">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-3 mt-8 pl-1 tracking-widest border-t border-slate-800 pt-6">Group B: å°ˆæ¡ˆå¯¦ä½œ (Output)</div>
                    
                    <div v-if="globalState.config?.assignmentType === 'group'" 
                         class="task-card p-5 rounded-2xl relative overflow-hidden mb-4 bg-slate-800/30 border-l-4 border-amber-500/50" 
                         :class="isUnlocked('assignment') ? '' : 'task-locked'">
                        <div class="flex gap-4 items-center relative z-10">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 bg-amber-900/20 text-amber-500">
                                <i class="fa-solid fa-comments"></i>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-slate-100 text-base">Group Discussion (åˆ†çµ„è¨è«–)</h3>
                                <p class="text-xs text-slate-400 mt-1">
                                    æ‚¨æ˜¯ <span class="text-amber-400 font-bold">[{{ isGroupRevealed ? myProfile.zodiac?.label : 'Wait...' }}]</span> çµ„ï¼Œé»æ“Šé€²å…¥è¨è«–å€ã€‚
                                </p>
                            </div>
                            <button @click="openLink('discussion')" class="shrink-0 bg-amber-600 hover:bg-amber-500 text-white px-4 py-3 rounded-xl text-sm font-bold transition shadow-lg flex items-center gap-2">
                                é€²å…¥è¨è«– <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="task-card p-5 rounded-2xl relative overflow-hidden mb-4 bg-slate-800/30" :class="getTaskClass('assignment')">
                        <div class="flex gap-4 items-start relative z-10">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 transition-all bg-slate-800 text-slate-600" :class="{'beacon-bg beacon-text': myTasks.assignment.done}">
                                <i :class="assignmentMeta.icon"></i>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-slate-100 text-base">{{ assignmentMeta.title }}</h3>
                                <p class="text-xs text-slate-400 mb-4 mt-1 leading-relaxed">{{ assignmentMeta.desc }}</p>
                                <div v-if="isUnlocked('assignment')" class="flex flex-col gap-2">
                                    <button @click="openLink('assignment')" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-bold border border-slate-600 hover:border-white text-slate-200">
                                        <i class="fa-solid fa-cloud-arrow-up"></i> å‰å¾€ç¹³äº¤
                                    </button>
                                    <button v-if="myTasks.assignment.started && !myTasks.assignment.done" @click="markDone('assignment')" class="w-full bg-amber-600 text-white px-4 py-3 rounded-xl text-sm font-bold hover:bg-amber-500 transition shadow-lg animate-pulse-slow">
                                        <i class="fa-solid fa-check-double"></i> æ¨™è¨˜å®Œæˆ
                                    </button>
                                </div>
                                <div v-else class="text-[10px] text-slate-500 font-bold border border-slate-700 px-2 py-1 rounded inline-block">ğŸ”’ å°šæœªé–‹æ”¾ç¹³äº¤</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-card p-5 rounded-2xl relative overflow-hidden bg-slate-800/30" :class="getTaskClass('gallery')">
                         <div class="flex gap-4 items-start relative z-10">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 transition-all bg-slate-800 text-slate-600" :class="{'beacon-bg beacon-text': myTasks.gallery.done}">
                                <i class="fa-solid fa-images"></i>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-slate-100 text-base">Exhibition (ä½œå“è³æ)</h3>
                                <p class="text-xs text-slate-400 mb-4 mt-1 leading-relaxed">è§€æ‘©åŒå­¸ä½œå“ã€‚</p>
                                <div v-if="isUnlocked('gallery')" class="flex flex-col gap-2">
                                    <button @click="openLink('gallery')" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-bold border border-slate-600 hover:border-white text-slate-200">
                                        <i class="fa-solid fa-eye"></i> é€²å…¥å±•è¦½
                                    </button>
                                    <button v-if="myTasks.gallery.started && !myTasks.gallery.done" @click="markDone('gallery')" class="w-full bg-pink-600 text-white px-4 py-3 rounded-xl text-sm font-bold hover:bg-pink-500 transition shadow-lg animate-pulse-slow">
                                        <i class="fa-solid fa-check"></i> æˆ‘å·²å®Œæˆè³æ
                                    </button>
                                </div>
                                <div v-else class="text-[10px] text-slate-500 font-bold border border-slate-700 px-2 py-1 rounded inline-block">ğŸ”’ å°šæœªé–‹æ”¾å±•è¦½</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<script type="module">
import { createApp, reactive, ref, computed, onMounted, onUnmounted, watch } from 'https://unpkg.com/vue@3.4.19/dist/vue.esm-browser.prod.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, onValue, runTransaction, get, update, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const CONFIG = {
    FIREBASE: {
        apiKey: "AIzaSyBPdK2Ptbc9srt8DY74URKQyNmceexM-ro",
        authDomain: "cmu-11402-pathophysiology.firebaseapp.com",
        databaseURL: "https://cmu-11402-pathophysiology-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cmu-11402-pathophysiology",
        storageBucket: "cmu-11402-pathophysiology.firebasestorage.app",
        messagingSenderId: "367793212618",
        appId: "1:367793212618:web:c11acedc50ce6fc3897833"
    },
    ZODIAC: [
        {label:'å­é¼ ', icon:'âš¡ï¸', element:'air'}, {label:'ä¸‘ç‰›', icon:'ğŸ§±', element:'earth'}, {label:'å¯…è™', icon:'ğŸ”¥', element:'fire'}, {label:'å¯å…”', icon:'ğŸ§', element:'water'},
        {label:'è¾°é¾', icon:'ğŸŒŸ', element:'fire'}, {label:'å·³è›‡', icon:'ğŸ§ ', element:'water'}, {label:'åˆé¦¬', icon:'ğŸš€', element:'fire'}, {label:'æœªç¾Š', icon:'ğŸ¤', element:'earth'},
        {label:'ç”³çŒ´', icon:'ğŸ’¡', element:'air'}, {label:'é…‰é›', icon:'â±', element:'earth'}, {label:'æˆŒç‹—', icon:'ğŸ›¡', element:'earth'}, {label:'äº¥è±¬', icon:'ğŸ“š', element:'water'}
    ],
    TASKS_META: {
        notebook: { title: 'Gathering (çŸ¥è­˜ç²å–)', desc: 'é–±è®€æŒ‡å®šæ•™æï¼Œä¸¦ä½¿ç”¨ AI è¼”åŠ©æ•´ç†é‡é»ã€‚', icon: 'fa-solid fa-book-sparkles' },
        slido: { title: 'Briefing (äº’å‹•æå•)', desc: 'é€²å…¥ Slido èŠå¤©å®¤ï¼Œåƒèˆ‡æŠ•ç¥¨æˆ–æå‡ºå•é¡Œã€‚', icon: 'fa-solid fa-users-rays' },
        forms: { title: 'Assessment (æˆæ•ˆæª¢æ ¸)', desc: 'å®Œæˆæœ€çµ‚æ¸¬é©—ï¼Œé©—è­‰ä»Šæ—¥å­¸ç¿’æˆæœã€‚', icon: 'fa-solid fa-clipboard-check' }
    }
};

const app = initializeApp(CONFIG.FIREBASE);
const db = getDatabase(app);

const sanitize = (str) => str ? str.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';
const getZodiacIcon = (label) => CONFIG.ZODIAC.find(z => z.label === label)?.icon || 'ğŸ‘¤';
const getBeaconClass = (label) => { if (!isGroupRevealed.value) return 'theme-secret'; const z = CONFIG.ZODIAC.find(x => x.label === label); return z ? `theme-${z.element}` : 'theme-earth'; };
const getCurrentIcon = () => { if (!isGroupRevealed.value) return 'â“'; return myProfile.zodiac?.icon || 'ğŸ‘¤'; };

function useSound() {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const playTone = (freq, type, duration, vol = 0.1) => {
        if (ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(vol, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
        osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + duration);
    };
    return { playSFX: (t) => {
        if(t==='success') { playTone(800,'sine',0.1); setTimeout(()=>playTone(1200,'sine',0.2),100); }
        else if(t==='error') { playTone(150,'sawtooth',0.3); setTimeout(()=>playTone(100,'sawtooth',0.3),100); }
        else if(t==='click') playTone(400,'triangle',0.05,0.05);
    }};
}

function useRoom(sessionId, myUid) {
    const isOnline = ref(navigator.onLine);
    const globalState = reactive({ phaseA: 'waiting', phaseB: 'waiting', links: {}, globalProgress: 0, loginStatus: 'open', config: {} });
    
    const initConnection = () => {
        window.addEventListener('online', () => isOnline.value = true);
        window.addEventListener('offline', () => isOnline.value = false);
        onValue(dbRef(db, ".info/connected"), (snap) => isOnline.value = snap.val() === true);
    };

    const startHeartbeat = () => {
        if (!myUid.value) return; 
        const userRef = dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`);
        onDisconnect(userRef).update({ status: 'offline', 'auth/isActive': false });
        const sendPulse = () => { if (navigator.onLine && document.visibilityState === 'visible') update(userRef, { lastSeen: Date.now(), status: 'online' }); };
        sendPulse(); setInterval(sendPulse, 10000);
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') sendPulse(); });
    };

    const initRoomSync = () => {
        onValue(dbRef(db, `classrooms/${sessionId.value}/status`), (snap) => { if(snap.exists()) Object.assign(globalState, snap.val()); });
    };
    return { isOnline, globalState, initConnection, startHeartbeat, initRoomSync };
}

function useTasks(sessionId, myUid, globalState, myProfile, addToast, playSFX) {
    const myTasks = reactive({ calibration: { done: false, confidence: 3 }, notebook: { done: false, started: false }, slido: { done: false, started: false }, forms: { done: false, started: false }, assignment: { done: false, started: false }, gallery: { done: false, started: false } });
    const tempCalibration = reactive({ confidence: 3 });
    const tempRating = ref(3);
    const tempFeedback = ref('');
    const isEditing = ref(false); 

    const initTaskSync = () => {
        if (!myUid.value) return; 
        onValue(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`), (snap) => {
            const val = snap.val();
            if(!val || (val.auth && !val.auth.isActive)) { localStorage.removeItem('zodiac_identity'); location.reload(); return; }
            if(val.tasks) Object.assign(myTasks, val.tasks);
            if(val.feedback) tempFeedback.value = val.feedback;
            if(val.rating) tempRating.value = val.rating;
        });
    };

    const assignmentMeta = computed(() => { const type = globalState.config?.assignmentType || 'individual'; return type === 'group' ? { title: 'Group Project (åˆ†çµ„å ±å‘Š)', desc: 'çµ„é•·ä¸Šå‚³ï¼Œçµ„å“¡ç¢ºèªã€‚', icon: 'fa-solid fa-users-viewfinder' } : { title: 'Individual Work (å€‹äººä½œæ¥­)', desc: 'è«‹ç¨ç«‹å®Œæˆä¸¦ä¸Šå‚³ã€‚', icon: 'fa-solid fa-user-pen' }; });

    const submitCalibration = () => {
        if (!myUid.value) { addToast("è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦", "error"); return; }
        const now = Date.now();
        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/calibration`), { done: true, confidence: tempCalibration.confidence, endTime: now, startTime: myTasks.calibration.startTime || (now - 6000), duration: 6 }).then(() => playSFX('success')).catch(e => addToast("æ ¡æº–å¤±æ•—: " + e.message, "error"));
    };

    const markDone = (k) => {
        if (!myUid.value) return;
        if (k === 'assignment' && globalState.config?.assignmentType === 'group') { if (!confirm("ã€èª ä¿¡ç¢ºèªã€‘\n\næˆ‘ç¢ºèªæˆ‘å·²åƒèˆ‡æœ¬çµ„è¨è«–ï¼Œä¸¦å°ç”¢å‡ºæœ‰æ‰€è²¢ç»ã€‚\n\n(ç³»çµ±å°‡è¨˜éŒ„æ­¤ç¢ºèªæ“ä½œ)")) return; }
        const now = Date.now(); let startTime = myTasks[k].startTime || (now - 10000); let duration = Math.round((now - startTime) / 1000);
        const updates = { done: true, endTime: now, duration, startTime };
        if (k === 'assignment') updates.type = globalState.config?.assignmentType || 'individual';
        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/${k}`), updates).then(() => playSFX('success')).catch(e => addToast("å¤±æ•—: " + e.message, "error"));
    };

    const isUnlocked = (k) => {
        if (k === 'calibration') return true; 
        if (!myTasks.calibration.done) return false;
        const pA = globalState.phaseA || 'waiting'; const pB = globalState.phaseB || 'waiting';
        if (k === 'notebook') return pA === 'warmup' || pA === 'main_open';
        if (k === 'slido') return pA === 'interact' || pA === 'main_open';
        if (k === 'forms') return pA === 'quiz' || pA === 'main_open';
        if (k === 'assignment') return pB === 'submission_open' || pB === 'final_show';
        if (k === 'gallery') return pB === 'gallery_open' || pB === 'final_show';
        return false;
    };
    const groupADone = computed(() => myTasks.notebook.done && myTasks.slido.done && myTasks.forms.done);
    const submitDebrief = () => { if (!myUid.value) return; if(tempFeedback.value.length < 5) return addToast("è«‹å¤šå¯«ä¸€é»å¿ƒå¾—", "error"); update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}`), { rating: tempRating.value, feedback: sanitize(tempFeedback.value) }); isEditing.value = false; addToast("å¿ƒå¾—èˆ‡è©•åˆ†å·²æ›´æ–°ï¼", "success"); };

    // [ä¿®æ”¹] é€£çµé–‹å•Ÿé‚è¼¯ï¼šæ”¯æ´å€‹äººä½œæ¥­åˆ†æµ
    const openLink = async (k) => {
        playSFX('click');

        // æƒ…å¢ƒ A: é»æ“Šã€Œåˆ†çµ„è¨è«–ã€ (Group Mode)
        // æƒ…å¢ƒ B: é»æ“Šã€Œä½œæ¥­ç¹³äº¤ã€ä¸”æ¨¡å¼ç‚ºã€Œå€‹äººã€ (Individual Mode åˆ†æµ)
        const isIndividualAssignment = k === 'assignment' && globalState.config?.assignmentType === 'individual';
        
        if (k === 'discussion' || isIndividualAssignment) {
            if (!myProfile.zodiac) { addToast("ç„¡æ³•è­˜åˆ¥æ‚¨çš„ç”Ÿè‚–èº«åˆ†", "error"); return; }
            
            const zodiacKey = myProfile.zodiac.label.charAt(0);
            const actionName = k === 'discussion' ? 'è¨è«–å€' : 'å€‹äººä½œæ¥­å€';
            
            addToast(`æ­£åœ¨å‰å¾€ [${zodiacKey}] ${actionName}...`, "info");
            
            try {
                const snapshot = await get(dbRef(db, `classrooms/${sessionId.value}/groupLinks/${zodiacKey}`));
                if (snapshot.exists()) {
                    const url = snapshot.val();
                    
                    // é˜²å‘†æç¤º
                    alert("ã€é‡è¦æé†’ã€‘\n\né€²å…¥ Padlet å¾Œï¼Œå› ç‚ºæ˜¯è¨ªå®¢èº«ä»½ï¼Œç³»çµ±ç„¡æ³•è‡ªå‹•å¸¶å…¥å§“åã€‚\n\nè«‹å‹™å¿…åœ¨è²¼æ–‡ã€Œæ¨™é¡Œã€è™•å¡«å¯«ï¼š\nğŸ‘‰ å­¸è™Ÿ + å§“å\n\nå¦å‰‡åŠ©æ•™ç„¡æ³•è©•åˆ†ï¼");

                    // å¦‚æœæ˜¯ä½œæ¥­ï¼Œè¨˜éŒ„é–‹å§‹æ™‚é–“
                    if(k === 'assignment' && myUid.value) {
                        update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/assignment`), { 
                            started: true, 
                            startTime: Date.now(),
                            type: 'individual'
                        });
                    }
                    window.open(url, '_blank');
                } else { 
                    addToast("è€å¸«å°šæœªè¨­å®šåˆ†çµ„é€£çµ", "error"); 
                }
            } catch (e) { 
                console.error(e); 
                addToast("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error"); 
            }
            return;
        }

        // æƒ…å¢ƒ C: å…¶ä»–é€£çµ
        if(myUid.value && !myTasks[k].started) {
            update(dbRef(db, `classrooms/${sessionId.value}/students/${myUid.value}/tasks/${k}`), { 
                started: true, 
                startTime: Date.now(),
                type: globalState.config?.assignmentType || 'general'
            });
        }
        if(globalState.links?.[k]) window.open(globalState.links[k], '_blank');
    };

    return { myTasks, tempCalibration, tempRating, tempFeedback, initTaskSync, markDone, isUnlocked, isEditing, groupADone, assignmentMeta, submitCalibration, submitDebrief, openLink };
}

function useIdentity(sessionId, addToast, changeView, playSFX, globalState) {
    const loading = ref(false); const claimingUser = ref(null); const myProfile = reactive({ uid: '', name: '', zodiac: null, studentId: '' });
    const searchStudent = async (sid) => {
        if(!sid) return addToast("è«‹è¼¸å…¥å­¸è™Ÿ", "error");
        loading.value = true;
        try { const s = await get(dbRef(db, `classrooms/${sessionId.value}/students/${sid.trim().toUpperCase()}`));
              if(s.exists()) { playSFX('click'); claimingUser.value = { uid: sid.trim().toUpperCase(), ...s.val() }; } 
              else addToast("ç„¡æ­¤å­¸è™Ÿ", "error"); } catch(e){ console.error(e); } finally { loading.value = false; }
    };
    const executeClaim = async (pin) => {
        if(!pin) return false; loading.value = true;
        try { 
            const t = crypto.randomUUID(); const targetUid = claimingUser.value.uid;
            await update(dbRef(db, `classrooms/${sessionId.value}/students/${targetUid}/auth`), { isActive: true, token: t, pin });
            const userData = { uid: targetUid, token: t, name: claimingUser.value.profile.Name, zodiac: claimingUser.value.profile.Zodiac, studentId: claimingUser.value.profile.StudentId };
            localStorage.setItem('zodiac_identity', JSON.stringify(userData));
            Object.assign(myProfile, userData); myProfile.zodiac = CONFIG.ZODIAC.find(z=>z.label===userData.zodiac);
            loading.value = false; return true;
        } catch(e) { addToast("éŒ¯èª¤: " + e.message, "error"); loading.value = false; return false; }
    };
    const attemptAutoLogin = async () => {
        const stored = localStorage.getItem('zodiac_identity');
        if(!stored) { changeView('roster'); return false; }
        loading.value = true;
        try {
            const local = JSON.parse(stored);
            const s = await get(dbRef(db, `classrooms/${sessionId.value}/students/${local.uid}/auth`));
            if(s.exists() && s.val().token === local.token) {
                Object.assign(myProfile, local); myProfile.zodiac = CONFIG.ZODIAC.find(z=>z.label===local.zodiac);
                update(dbRef(db, `classrooms/${sessionId.value}/students/${local.uid}/auth`), { isActive: true });
                changeView('dashboard'); loading.value = false; return true; 
            } else { localStorage.removeItem('zodiac_identity'); changeView('roster'); loading.value = false; return false; }
        } catch(e) { changeView('roster'); loading.value = false; return false; }
    };
    return { loading, claimingUser, myProfile, searchStudent, executeClaim, attemptAutoLogin, logout: ()=>{ localStorage.removeItem('zodiac_identity'); location.reload(); } };
}

createApp({
    setup() {
        const form = reactive({ sessionId: '', pin: '' });
        const viewState = ref('entry');
        const toasts = ref([]);
        const searchQuery = ref('');
        const sessionRef = computed(() => form.sessionId);
        const { playSFX } = useSound();
        const addToast = (msg, type='info') => { toasts.value.push({id:Date.now(), msg, type, icon: type==='error'?'fa-circle-xmark':'fa-circle-info'}); setTimeout(()=>toasts.value.shift(),3000); };
        
        const myProfile = reactive({ uid: '', name: '', zodiac: null, studentId: '' });
        const myUidRef = computed(()=>myProfile.uid);
        
        const { isOnline, globalState, initConnection, startHeartbeat, initRoomSync } = useRoom(sessionRef, myUidRef);
        const { loading, claimingUser, myProfile: idProfile, executeClaim, attemptAutoLogin, searchStudent, logout } = useIdentity(sessionRef, addToast, (v)=>viewState.value=v, playSFX, globalState);
        watch(idProfile, (newP) => { if(newP) Object.assign(myProfile, newP); });

        const { myTasks, tempCalibration, tempRating, tempFeedback, initTaskSync, markDone, isUnlocked, isEditing, groupADone, assignmentMeta, submitCalibration, submitDebrief, openLink } = useTasks(sessionRef, myUidRef, globalState, myProfile, addToast, playSFX);

        onMounted(() => {
            const pid = new URLSearchParams(window.location.search).get('id');
            if(pid) { form.sessionId = pid; setTimeout(() => { attemptAutoLogin().then((success) => { if(success) { initRoomSync(); initTaskSync(); startHeartbeat(); } }); }, 500); }
            initConnection();
        });

        const enterRoom = async () => { 
            if(!form.sessionId) return addToast("è«‹è¼¸å…¥ä»£ç¢¼", "error");
            playSFX('click');
            const success = await attemptAutoLogin();
            if(success) { initRoomSync(); initTaskSync(); startHeartbeat(); }
        };
        
        const executeAtomicClaim = async () => {
            playSFX('click');
            const success = await executeClaim(form.pin);
            if(success) { initRoomSync(); initTaskSync(); startHeartbeat(); claimingUser.value = null; viewState.value = 'dashboard'; }
        };

        const getTaskClass = (k) => {
            if(myTasks[k].done) return 'task-done beacon-border'; 
            if(myTasks[k].started) return 'task-active beacon-border'; 
            if(!isUnlocked(k)) return 'task-locked';
            return 'bg-slate-800/50 border-transparent'; 
        };

        // --- [æ–°å¢] æ­æ›‰é‚è¼¯ ---
        const isGroupRevealed = computed(() => globalState.config?.enableGroupB === true);
        const getBeaconClass = (label) => { if (!isGroupRevealed.value) return 'theme-secret'; const z = CONFIG.ZODIAC.find(x => x.label === label); return z ? `theme-${z.element}` : 'theme-earth'; };
        const getCurrentIcon = () => { if (!isGroupRevealed.value) return 'â“'; return myProfile.zodiac?.icon || 'ğŸ‘¤'; };

        return { form, viewState, loading, toasts, searchQuery, isOnline, claimingUser, myProfile: computed(()=>myProfile), globalState,
                 enterRoom, handleSearch: ()=>searchStudent(searchQuery.value), executeAtomicClaim, logout,
                 myTasks, mainTasks: CONFIG.TASKS_META, assignmentMeta, tempCalibration, tempRating, tempFeedback,
                 getTaskClass, isUnlocked, groupADone, isEditing,
                 submitCalibration, submitDebrief, openLink, markDone,
                 getZodiacIcon, 
                 getBeaconClass, isGroupRevealed, getCurrentIcon, // <--- å°å‡ºæ–°é‚è¼¯
                 globalProgress: computed(()=>globalState.globalProgress)
        };
    }
}).mount('#app');
</script>
</body>
</html>