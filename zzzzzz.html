<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zodiac Ops Center | v4.38 Strict (Patched)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { slate: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #0f172a; color: #f1f5f9; }
        .h-screen-dvh { height: 100vh; height: 100dvh; } 
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 12px; height: 12px; } 
        ::-webkit-scrollbar-track { background: #1e293b; } 
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 6px; border: 2px solid #1e293b; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .panel-card { background: #1e293b; border: 1px solid #475569; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; border: 1px solid rgba(255,255,255,0.1); }
        .status-online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background-color: #64748b; opacity: 0.5; } 
        .status-late { background-color: #f59e0b; }
        .elm-fire { border-left: 6px solid #ef4444; } .elm-water { border-left: 6px solid #3b82f6; } 
        .elm-air { border-left: 6px solid #fbbf24; } .elm-earth { border-left: 6px solid #22c55e; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }

        /* [UI é™å™ª] ç§»é™¤æœªé¸å–æŒ‰éˆ•çš„é‚Šæ¡†ï¼Œåƒ…åœ¨ Active æ™‚ç™¼å…‰ */
        .btn-phase { transition: all 0.2s; border: 1px solid transparent; background: #0f172a; color: #64748b; }
        .btn-phase:hover { background: #1e293b; color: #94a3b8; }
        
        .btn-active-A { background: rgba(59, 130, 246, 0.15) !important; border-color: #3b82f6 !important; color: #60a5fa !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .btn-active-B { background: rgba(245, 158, 11, 0.15) !important; border-color: #f59e0b !important; color: #fbbf24 !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
    </style>
</head>
<body class="overflow-hidden text-base">

<div id="app" v-cloak class="h-screen-dvh flex flex-col relative text-slate-100">
    
    <div class="fixed top-8 right-4 z-[9999] flex flex-col gap-3 pointer-events-none">
        <transition-group name="toast">
            <div v-for="t in toasts" :key="t.id" @click="toasts.splice(toasts.indexOf(t), 1)" class="cursor-pointer pointer-events-auto px-6 py-4 rounded-xl shadow-2xl border-2 border-slate-600 bg-slate-800 text-white flex items-center gap-4 min-w-[320px]">
                <i :class="t.icon" class="text-2xl" :class="t.type==='error'?'text-red-400':(t.type==='success'?'text-emerald-400':'text-blue-400')"></i>
                <div class="text-base font-bold tracking-wide">{{ t.msg }}</div>
            </div>
        </transition-group>
    </div>

    <nav class="bg-slate-900 border-b border-slate-700 h-20 flex-none relative z-50">
        <div class="container mx-auto px-6 h-full flex justify-between items-center max-w-7xl">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center text-white shadow-lg text-xl"><i class="fa-solid fa-shield-halved"></i></div>
                <div><div class="font-bold text-xl text-white tracking-wide">ZODIAC OPS</div><div class="text-xs text-slate-400 font-mono tracking-widest">TEACHER v4.38 STRICT</div></div>
            </div>
            <div class="hidden md:flex items-center gap-8 absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-800 px-8 py-2 rounded-full border border-slate-600">
                <div class="flex flex-col items-center"><span class="text-[10px] text-slate-400 tracking-wider font-bold uppercase">ç¸½äººæ•¸</span><span class="text-2xl font-mono font-bold leading-none text-white">{{ studentCount }}</span></div>
                <div class="w-px h-8 bg-slate-600"></div>
                <div class="flex flex-col items-center"><span class="text-[10px] text-emerald-400 tracking-wider font-bold uppercase">å·²é€£ç·š</span><span class="text-2xl font-mono font-bold leading-none text-emerald-400">{{ activeCount }}</span></div>
            </div>
            <div class="flex gap-3">
                <button @click="showHistory=true" class="bg-slate-800 border border-slate-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 hover:border-white transition flex items-center gap-2" title="åˆ‡æ›å…¶ä»–èª²å ‚"><i class="fa-solid fa-clock-rotate-left text-amber-400 text-lg"></i> æ­·å²ç´€éŒ„</button>
                <button @click="showImporter=true" class="bg-slate-800 border border-slate-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 hover:border-white transition flex items-center gap-2"><i class="fa-solid fa-file-excel text-green-400 text-lg"></i> åå–®å·¥å…·</button>
                <button @click="copyLink" class="bg-indigo-900 border border-indigo-500 text-indigo-100 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-800 hover:border-indigo-300 transition flex items-center gap-2"><i class="fa-solid fa-link text-lg"></i> <span class="hidden sm:inline">è¤‡è£½é€£çµ</span></button>
                <button @click="logout" class="bg-red-900/50 border border-red-500 text-red-200 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-red-900 hover:border-red-300 transition">ç™»å‡º</button>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1.5 bg-slate-800"><div class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-1000" :style="`width:${globalProgress}%`"></div></div>
    </nav>

    <main class="flex-1 h-0 overflow-y-auto p-4 md:p-6 bg-slate-950 relative">
        
        <div v-if="!hasJoined" class="fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center p-6 relative">
            <div class="w-full max-w-md panel-card rounded-2xl p-8 shadow-2xl border-slate-600">
                <h2 class="text-3xl font-bold text-white mb-8 text-center">èº«ä»½é©—è­‰</h2>
                <div class="space-y-6">
                    <div>
                        <label class="text-sm font-bold text-slate-400 uppercase mb-2 block">Session ID (æ•™å®¤ä»£ç¢¼)</label>
                        <div class="flex gap-3">
                            <input v-model="form.sessionId" class="w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-xl font-mono font-bold text-center text-2xl text-white tracking-widest" readonly>
                            <button @click="refreshId" class="bg-slate-700 hover:bg-slate-600 text-white px-6 rounded-xl border border-slate-500 transition" title="æ›ä¸€çµ„è™Ÿç¢¼"><i class="fa-solid fa-rotate text-xl"></i></button>
                        </div>
                        <div class="text-right mt-2">
                            <a href="#" @click.prevent="showHistory=true" class="text-sm text-blue-400 hover:text-blue-300 underline">åˆ‡æ›è‡³èˆŠèª²å ‚...</a>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-400 uppercase mb-2 block">Access Key (æ•™å¸«å¯†ç¢¼)</label>
                        <input v-model="form.password" type="password" class="w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-xl text-center text-xl text-white placeholder-slate-600" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" @keyup.enter="login">
                    </div>
                    <button @click="login" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-5 rounded-xl text-xl font-bold transition border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 shadow-xl">å•Ÿå‹•ç³»çµ±</button>
                </div>
            </div>
        </div>

        <div v-if="showHistory" class="fixed inset-0 z-[160] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="panel-card w-full max-w-lg rounded-2xl p-8 shadow-2xl flex flex-col border-slate-500">
                <div class="flex justify-between items-center mb-6 border-b border-slate-600 pb-4">
                    <h3 class="text-2xl font-bold text-white flex items-center gap-3"><i class="fa-solid fa-clock-rotate-left text-amber-400"></i> èª²å ‚æ™‚å…‰æ©Ÿ</h3>
                    <button @click="showHistory=false" class="bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-lg transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="text-sm text-slate-400">é»æ“Šä»¥ä¸‹ç´€éŒ„å¯åˆ‡æ›è‡³è©²èª²å ‚ï¼š</div>
                    <div class="max-h-[300px] overflow-y-auto space-y-2 pr-2">
                        <div v-for="h in sessionHistory" :key="h.id" @click="switchSession(h.id)" class="p-4 rounded-xl border border-slate-700 hover:bg-slate-700 hover:border-amber-500 cursor-pointer transition group flex justify-between items-center" :class="h.id === form.sessionId ? 'bg-slate-800 border-green-500' : 'bg-slate-900'">
                            <div>
                                <div class="font-mono font-bold text-lg group-hover:text-amber-300" :class="h.id === form.sessionId ? 'text-green-400' : 'text-white'">{{ h.id }}</div>
                                <div class="text-xs text-slate-500">{{ h.date }}</div>
                            </div>
                            <div v-if="h.id === form.sessionId" class="text-green-500 text-xs font-bold uppercase px-2 py-1 bg-green-900/30 rounded">Current</div>
                            <div v-else class="opacity-0 group-hover:opacity-100 text-slate-400"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <div v-if="sessionHistory.length === 0" class="text-center py-8 text-slate-500">å°šç„¡æ­·å²ç´€éŒ„</div>
                    </div>
                    
                    <div class="pt-4 mt-4 border-t border-slate-600">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">æ‰‹å‹•è¼¸å…¥ ID</label>
                        <div class="flex gap-2">
                            <input v-model="manualSessionId" placeholder="ä¾‹å¦‚ï¼š20250101-ABCD" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white font-mono uppercase">
                            <button @click="switchSession(manualSessionId)" :disabled="!manualSessionId" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold transition disabled:opacity-50">Go</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showImporter" class="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="panel-card w-full max-w-4xl rounded-2xl p-8 shadow-2xl flex flex-col max-h-[90vh] border-slate-500">
                <div class="flex justify-between items-center mb-6 border-b border-slate-600 pb-4">
                    <h3 class="text-2xl font-bold text-white flex items-center gap-3"><i class="fa-solid fa-table-list text-yellow-400"></i> åå–®ç®¡ç†å·¥å…·</h3>
                    <button @click="showImporter=false" class="bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-lg transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-6">
                    <div class="flex gap-4 p-5 bg-slate-800 rounded-xl border border-slate-600 flex-wrap">
                        <div class="flex items-center gap-3"><input type="radio" v-model="importMode" value="append" id="mode_append" class="w-6 h-6 accent-blue-500"><label for="mode_append" class="text-lg font-bold text-white cursor-pointer">åŠ é¸ (Append)</label></div>
                        <div class="w-px h-8 bg-slate-600"></div>
                        <div class="flex items-center gap-3"><input type="radio" v-model="importMode" value="sync" id="mode_sync" class="w-6 h-6 accent-amber-500"><label for="mode_sync" class="text-lg font-bold text-amber-300 cursor-pointer">æ ¡æ­£ (Sync)</label></div>
                        <div class="w-px h-8 bg-slate-600"></div>
                        <div class="flex items-center gap-3"><input type="radio" v-model="importMode" value="overwrite" id="mode_overwrite" class="w-6 h-6 accent-red-500"><label for="mode_overwrite" class="text-lg font-bold text-red-300 cursor-pointer">é‡ç½® (Reset)</label></div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="text-sm font-bold text-slate-300 uppercase">è²¼ä¸Š Excel / CSV è³‡æ–™</div>
                            <textarea v-model="importRaw" @input="parseInput" class="w-full h-64 bg-slate-900 font-mono text-base text-white p-4 rounded-xl border-2 border-slate-600 focus:border-blue-500 resize-none" placeholder="æ”¯æ´ Excel è¤‡è£½æ ¼å¼ï¼š&#10;ç‹å°æ˜  é†«å­¸ç³»  108001&#10;æå¤§è¯  ç‰™é†«ç³»  108002"></textarea>
                        </div>
                        <div class="space-y-3">
                            <div class="text-sm font-bold text-slate-300 uppercase">é è¦½çµæœ</div>
                            <div class="w-full h-64 bg-slate-900 rounded-xl border-2 border-slate-600 overflow-y-auto p-2">
                                <table class="w-full text-left border-collapse" v-if="parsedPreview.length > 0">
                                    <thead class="text-xs text-slate-400 border-b border-slate-700 sticky top-0 bg-slate-900"><tr><th class="p-2">å­¸è™Ÿ (Col 3)</th><th class="p-2">å§“å (Col 1)</th><th class="p-2">ç‹€æ…‹</th></tr></thead>
                                    <tbody class="text-sm font-mono text-white">
                                        <tr v-for="r in parsedPreview" :key="r.id" class="border-b border-slate-800"><td class="p-2">{{ r.id }}</td><td class="p-2">{{ r.name }}</td><td class="p-2 font-bold" :class="r.exists ? 'text-yellow-400' : 'text-green-400'">{{ r.exists ? (importMode==='append'?'ç•¥é':'æ›´æ–°') : 'æ–°å¢' }}</td></tr>
                                    </tbody>
                                </table>
                                <div v-else class="h-full flex items-center justify-center text-slate-500 text-lg">ç­‰å¾…è¼¸å…¥è³‡æ–™...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pt-6 mt-6 border-t border-slate-600 flex justify-end gap-4">
                    <button @click="generateDemoRoster" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-xl font-bold transition">è¼‰å…¥ç¯„ä¾‹è³‡æ–™</button>
                    <button @click="executeImport" :disabled="parsedPreview.length === 0" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-lg font-bold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="importMode==='append'">ç¢ºèªåŠ é¸</span><span v-else-if="importMode==='sync'">ç¢ºèªæ ¡æ­£</span><span v-else>ç¢ºèªé‡ç½®</span>
                    </button>
                </div>
            </div>
        </div>

        <div v-else class="container mx-auto max-w-7xl space-y-6 relative z-10">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-4 panel-card rounded-2xl p-6 flex flex-col justify-between relative overflow-hidden bg-slate-800 border-l-4 border-l-blue-500">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">SESSION ID</div>
                            <div class="text-3xl font-mono font-bold text-white tracking-wider text-shadow cursor-pointer hover:text-blue-400 transition" @click="copySessionId" title="é»æ“Šè¤‡è£½ä»£ç¢¼">{{ form.sessionId }}</div>
                        </div>
                        <div class="bg-white p-2 rounded-xl cursor-pointer hover:scale-105 transition shadow-lg" @click="copySessionId" title="é»æ“Šè¤‡è£½ Session ID (ä¸æ˜¯é€£çµ)"><img :src="qrCodeUrl" class="w-16 h-16 rounded"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="text-sm font-bold text-blue-300 uppercase border-b border-blue-500/30 pb-1 mb-2">1. é–€ç¦ç®¡ç† (Login Control)</div>
                        <p class="text-xs text-slate-400 mb-2">æ­¤é–‹é—œåƒ…æ§åˆ¶ã€Œå­¸ç”Ÿèƒ½å¦ç™»å…¥ã€ï¼Œä¸å½±éŸ¿ä»»å‹™é–‹æ”¾ã€‚</p>
                        <div class="grid grid-cols-3 gap-3">
                            <button @click="setStatus('open')" class="py-4 rounded-xl text-sm font-bold border-2 transition flex flex-col items-center gap-1" :class="state.loginStatus==='open'?'bg-emerald-600 border-emerald-400 text-white shadow-[0_0_15px_rgba(16,185,129,0.4)]':'bg-slate-900 border-slate-700 text-slate-500 hover:bg-slate-700 hover:text-white'">
                                <i class="fa-solid fa-door-open text-2xl"></i> é–‹æ”¾å…¥å ´
                            </button>
                            <button @click="setStatus('late')" class="py-4 rounded-xl text-sm font-bold border-2 transition flex flex-col items-center gap-1" :class="state.loginStatus==='late'?'bg-amber-600 border-amber-400 text-white shadow-[0_0_15px_rgba(245,158,11,0.4)]':'bg-slate-900 border-slate-700 text-slate-500 hover:bg-slate-700 hover:text-white'">
                                <i class="fa-solid fa-clock text-2xl"></i> è¨­ç‚ºé²åˆ°
                            </button>
                            <button @click="setStatus('locked')" class="py-4 rounded-xl text-sm font-bold border-2 transition flex flex-col items-center gap-1" :class="state.loginStatus==='locked'?'bg-red-600 border-red-400 text-white shadow-[0_0_15px_rgba(239,68,68,0.4)]':'bg-slate-900 border-slate-700 text-slate-500 hover:bg-slate-700 hover:text-white'">
                                <i class="fa-solid fa-lock text-2xl"></i> ç¦æ­¢å…¥å ´
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 grid grid-cols-1 gap-6 h-full">
                    <div class="panel-card rounded-2xl p-6 flex flex-col bg-slate-800">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-sm font-bold text-slate-400 uppercase">èª²ç¨‹é…ç½® (Config) èˆ‡é€£çµ</span>
                            <button @click="syncLinks" :class="linksDirty ? 'bg-emerald-600 text-white animate-pulse' : 'bg-slate-700 text-slate-400'" class="px-4 py-2 rounded-lg text-xs font-bold transition border border-slate-600"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> {{ linksDirty ? 'å„²å­˜è®Šæ›´' : 'å·²åŒæ­¥' }}</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-4 mb-6 border-b border-slate-700 pb-6">
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-2 cursor-pointer bg-slate-900 px-3 py-2 rounded border border-slate-700 hover:border-blue-500 transition select-none">
                                    <input type="checkbox" :checked="state.config?.enableGroupA" @change="updateConfig('enableGroupA', $event.target.checked)" class="w-4 h-4 accent-blue-500">
                                    <span class="text-xs font-bold text-slate-300">å•Ÿç”¨ Group A (å­¸ç¿’)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-slate-900 px-3 py-2 rounded border border-slate-700 hover:border-amber-500 transition select-none">
                                    <input type="checkbox" :checked="state.config?.enableGroupB" @change="updateConfig('enableGroupB', $event.target.checked)" class="w-4 h-4 accent-amber-500">
                                    <span class="text-xs font-bold text-slate-300">å•Ÿç”¨ Group B (å°ˆæ¡ˆ)</span>
                                </label>
                            </div>
                            <div class="w-px h-10 bg-slate-700 mx-2"></div>
                            <div class="flex bg-slate-900 rounded border border-slate-700 p-1" v-if="state.config?.enableGroupB">
                                <button @click="updateConfig('assignmentType', 'individual')" class="px-3 py-1 rounded text-[10px] font-bold transition" :class="state.config?.assignmentType==='individual'?'bg-slate-700 text-white':'text-slate-500'">å€‹äººä½œæ¥­</button>
                                <button @click="updateConfig('assignmentType', 'group')" class="px-3 py-1 rounded text-[10px] font-bold transition" :class="state.config?.assignmentType==='group'?'bg-amber-700 text-white':'text-slate-500'">åˆ†çµ„å ±å‘Š</button>
                            </div>
                        </div>

                        <div class="space-y-4 flex-1 overflow-y-auto">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-book text-blue-400 w-5 text-center"></i><input v-model="localLinks.notebook" @input="linksDirty=true" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white" placeholder="Notebook URL..."></div>
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-comments text-indigo-400 w-5 text-center"></i><input v-model="localLinks.slido" @input="linksDirty=true" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white" placeholder="Slido URL..."></div>
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-purple-400 w-5 text-center"></i><input v-model="localLinks.forms" @input="linksDirty=true" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white" placeholder="Forms URL..."></div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-file-arrow-up text-amber-400 w-5 text-center"></i><input v-model="localLinks.assignment" @input="linksDirty=true" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white" placeholder="Google Form URL..."></div>
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-images text-pink-400 w-5 text-center"></i><input v-model="localLinks.gallery" @input="linksDirty=true" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white" placeholder="Gallery URL..."></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-card rounded-2xl p-6 bg-slate-800 border-t-4 border-t-emerald-500 shadow-2xl">
                 <div class="text-sm font-bold text-emerald-300 uppercase border-b border-emerald-500/30 pb-2 mb-4">
                    <span>2. ä»»å‹™éšæ®µæ§åˆ¶ (Phase Control - Dual Track)</span>
                 </div>
                 
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div :class="{'opacity-40 pointer-events-none': !state.config?.enableGroupA}" class="transition-opacity">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs font-bold text-blue-400 border-l-2 border-blue-500 pl-2">Group A: å­¸ç¿’æ ¸å¿ƒ (70%)</div>
                            <button @click="switchPhase('waiting', 'A')" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition flex items-center gap-1" :class="state.phaseA==='waiting'?'ring-2 ring-slate-500':''"><i class="fa-solid fa-pause"></i> æš«åœ A</button>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button @click="switchPhase('warmup', 'A')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1" :class="{'btn-active-A': state.phaseA==='warmup'}"><i class="fa-solid fa-book-open text-xl"></i><span class="text-[10px] font-bold">é–±è®€</span></button>
                            <button @click="switchPhase('interact', 'A')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1" :class="{'btn-active-A': state.phaseA==='interact'}"><i class="fa-solid fa-comments text-xl"></i><span class="text-[10px] font-bold">äº’å‹•</span></button>
                            <button @click="switchPhase('quiz', 'A')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1" :class="{'btn-active-A': state.phaseA==='quiz'}"><i class="fa-solid fa-pen-to-square text-xl"></i><span class="text-[10px] font-bold">æ¸¬é©—</span></button>
                            <button @click="switchPhase('main_open', 'A')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1 border-blue-500/30" :class="{'btn-active-A': state.phaseA==='main_open'}"><i class="fa-solid fa-rocket text-xl"></i><span class="text-[10px] font-bold">å…¨é–‹</span></button>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-2 text-center">* å®Œæˆä¸Šè¿°ä»»å‹™å¾Œï¼Œå­¸ç”Ÿå¯è‡ªå‹•è§£é–ã€Œç¸½çµåæ€ (Debrief)ã€</div>
                     </div>

                     <div :class="{'opacity-40 pointer-events-none': !state.config?.enableGroupB}" class="transition-opacity">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs font-bold text-amber-400 border-l-2 border-amber-500 pl-2">Group B: å°ˆæ¡ˆå¯¦ä½œ (30%)</div>
                            <button @click="switchPhase('waiting', 'B')" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition flex items-center gap-1" :class="state.phaseB==='waiting'?'ring-2 ring-slate-500':''"><i class="fa-solid fa-pause"></i> æš«åœ B</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="switchPhase('submission_open', 'B')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1" :class="{'btn-active-B': state.phaseB==='submission_open'}"><i class="fa-solid fa-file-arrow-up text-xl"></i><span class="text-[10px] font-bold">åƒ…ç¹³äº¤</span></button>
                            <button @click="switchPhase('gallery_open', 'B')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1" :class="{'btn-active-B': state.phaseB==='gallery_open'}"><i class="fa-solid fa-images text-xl"></i><span class="text-[10px] font-bold">åƒ…å±•è¦½</span></button>
                            <button @click="switchPhase('final_show', 'B')" class="btn-phase p-3 rounded-lg flex flex-col items-center gap-1 border-amber-500/30" :class="{'btn-active-B': state.phaseB==='final_show'}"><i class="fa-solid fa-star text-xl"></i><span class="text-[10px] font-bold">é›™é–‹</span></button>
                        </div>
                     </div>
                 </div>
            </div>

            <div class="panel-card rounded-2xl overflow-hidden flex flex-col min-h-[500px] bg-slate-800">
                <div class="p-5 border-b border-slate-600 bg-slate-900 flex justify-between items-center sticky top-0 z-20">
                    <h3 class="font-bold text-slate-200 text-lg flex items-center gap-3"><i class="fa-solid fa-users"></i> å­¸ç”Ÿåå–®ç›£æ§ <span class="bg-blue-900 text-blue-200 text-sm px-3 py-0.5 rounded-full border border-blue-700">{{ displayedList.length }} äºº</span></h3>
                    <div class="flex gap-2">
                        <button @click="syncToSheets" :disabled="isSyncing" class="bg-emerald-700 hover:bg-emerald-600 disabled:bg-slate-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2"><i v-if="isSyncing" class="fa-solid fa-circle-notch animate-spin"></i><i v-else class="fa-solid fa-file-export"></i> åŒ¯å‡ºè‡³ GAS</button>
                        <input v-model="searchQuery" placeholder="æœå°‹å§“åæˆ–å­¸è™Ÿ..." class="bg-slate-800 border-2 border-slate-600 rounded-lg px-4 py-2 text-sm text-white focus:border-blue-500 w-64">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900 text-xs font-bold text-slate-400 uppercase sticky top-0 z-10 shadow-md">
                            <tr>
                                <th class="p-4 pl-6">#</th>
                                <th class="p-4">å­¸ç”Ÿè³‡æ–™</th>
                                <th class="p-4 text-center">ç¸½åˆ†</th>
                                <th class="p-4">Group A (Learning)</th>
                                <th class="p-4 border-l border-slate-700">Group B (Project)</th>
                                <th class="p-4 text-right pr-6">é€£ç·šç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700 text-base font-mono">
                            <tr v-for="s in displayedList" :key="s.uid" class="hover:bg-slate-700 transition-colors group" :class="getBeaconClass(s)">
                                <td class="p-4 pl-6 text-slate-500">{{ s.rank }}</td>
                                <td class="p-4 relative">
                                    <div class="font-bold text-white text-lg tracking-wide">{{ s.profile?.Name }}</div>
                                    <div class="text-sm text-slate-400">{{ s.profile?.StudentId }} <span class="text-slate-600">| {{ s.profile?.Zodiac }}</span></div>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 flex gap-3 bg-slate-800 p-1 rounded-lg shadow-lg border border-slate-600">
                                        <button v-if="s.auth?.isActive" @click="revokeToken(s.uid, s.profile?.Name)" class="text-amber-400 hover:bg-amber-900/50 p-2 rounded transition" title="å¼·åˆ¶ç™»å‡º"><i class="fa-solid fa-link-slash"></i></button>
                                        <button @click="deleteStudent(s.uid, s.profile?.Name)" class="text-red-400 hover:bg-red-900/50 p-2 rounded transition" title="åˆªé™¤å­¸ç”Ÿ"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                                <td class="p-4 text-center">
                                    <div class="flex flex-col items-center">
                                        <span class="font-bold text-xl" :class="calculateScore(s)>=90?'text-emerald-400':'text-slate-200'">{{ calculateScore(s) }}</span>
                                        <div v-if="isSpeedrun(s)" class="text-[10px] px-2 py-0.5 rounded-full mt-1 font-bold bg-red-600 text-white">SPEEDRUN</div>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <div class="flex items-center gap-2">
                                        <div class="status-dot" :class="s.tasks?.calibration?.done?'bg-teal-500 shadow-[0_0_5px_#14b8a6]':'bg-slate-800'" title="æ ¡æº–"></div>
                                        <div class="status-dot" :class="s.tasks?.notebook?.done?'bg-blue-500 shadow-[0_0_5px_#3b82f6]':'bg-slate-800'" title="é–±è®€"></div>
                                        <div class="status-dot" :class="s.tasks?.slido?.done?'bg-indigo-500 shadow-[0_0_5px_#6366f1]':'bg-slate-800'" title="äº’å‹•"></div>
                                        <div class="status-dot" :class="s.tasks?.forms?.done?'bg-purple-500 shadow-[0_0_5px_#a855f7]':'bg-slate-800'" title="æ¸¬é©—"></div>
                                        <div class="w-px h-4 bg-slate-600 mx-1"></div>
                                        <div class="status-dot" :class="s.rating > 0?'bg-white shadow-[0_0_5px_white]':'bg-slate-800'" title="ç¸½çµ(Debrief)"></div>
                                    </div>
                                </td>
                                <td class="p-4 border-l border-slate-700">
                                    <div class="flex items-center gap-2">
                                        <div class="status-dot" :class="s.tasks?.assignment?.done?'bg-amber-500 shadow-[0_0_5px_#f59e0b]':'bg-slate-800'" title="å¿ƒå¾—ç¹³äº¤"></div>
                                        <div class="status-dot" :class="s.tasks?.gallery?.done?'bg-pink-500 shadow-[0_0_5px_#ec4899]':'bg-slate-800'" title="å±•è¦½"></div>
                                        <span v-if="s.tasks?.assignment?.type === 'group'" class="text-[9px] border border-amber-500/50 text-amber-500 px-1 rounded ml-2">GRP</span>
                                    </div>
                                </td>
                                <td class="p-4 text-right pr-6"><span class="status-dot" :class="getStatusColor(s)"></span></td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="displayedList.length === 0" class="text-center py-20 text-slate-500 text-lg">
                        <i class="fa-solid fa-clipboard-list text-4xl mb-4 block"></i>
                        ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œè«‹é»æ“Šä¸Šæ–¹ [åå–®å·¥å…·] åŒ¯å…¥ã€‚
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
import { createApp, reactive, ref, computed, onMounted, onUnmounted, watch } from 'https://unpkg.com/vue@3.4.19/dist/vue.esm-browser.prod.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref as dbRef, update, onValue, set, remove, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const CONFIG = {
    FIREBASE: {
        apiKey: "AIzaSyBPdK2Ptbc9srt8DY74URKQyNmceexM-ro",
        authDomain: "cmu-11402-pathophysiology.firebaseapp.com",
        databaseURL: "https://cmu-11402-pathophysiology-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cmu-11402-pathophysiology",
        storageBucket: "cmu-11402-pathophysiology.firebasestorage.app",
        messagingSenderId: "367793212618",
        appId: "1:367793212618:web:c11acedc50ce6fc3897833",
        measurementId: "G-493SYB75VB"
    },
    GAS_URL: "https://script.google.com/macros/s/AKfycbyUjUj--8y3LwDUhjjosPUwAwojHeWxGG-KmB0ZNPdBrm_Pc-_UA8stK5LZsitp0XuyUw/exec", 
    ZODIAC: [
        {label:'å­é¼ ', element:'air'}, {label:'ä¸‘ç‰›', element:'earth'}, {label:'å¯…è™', element:'fire'}, {label:'å¯å…”', element:'water'},
        {label:'è¾°é¾', element:'fire'}, {label:'å·³è›‡', element:'water'}, {label:'åˆé¦¬', element:'fire'}, {label:'æœªç¾Š', element:'earth'},
        {label:'ç”³çŒ´', element:'air'}, {label:'é…‰é›', element:'earth'}, {label:'æˆŒç‹—', element:'earth'}, {label:'äº¥è±¬', element:'water'}
    ],
    // Phases Definition kept for reference
    PHASES: { 
        waiting: { shortLabel:'ç­‰å¾… (Wait)', icon:'fa-solid fa-pause', color:'slate' }, 
        warmup: { shortLabel:'é–±è®€ (Read)', icon:'fa-solid fa-book-open', color:'blue' }, 
        interact: { shortLabel:'äº’å‹• (Slido)', icon:'fa-solid fa-comments', color:'indigo' }, 
        quiz: { shortLabel:'æ¸¬é©— (Quiz)', icon:'fa-solid fa-pen-to-square', color:'purple' }, 
        main_open: { shortLabel:'ğŸ”¥ å­¸ç¿’å…¨é–‹', icon:'fa-solid fa-rocket', color:'blue' },
        submission_open: { shortLabel:'ğŸ“‚ åƒ…ç¹³äº¤', icon:'fa-solid fa-file-arrow-up', color:'amber' },
        gallery_open: { shortLabel:'ğŸ–¼ï¸ åƒ…å±•è¦½', icon:'fa-solid fa-images', color:'pink' },
        final_show: { shortLabel:'ğŸš€ æˆæœå…¨é–‹', icon:'fa-solid fa-star', color:'rose' }
    }
};

const app = initializeApp(CONFIG.FIREBASE);
const db = getDatabase(app);
const auth = getAuth(app);

const sanitize = (str) => {
    if (!str) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return str.replace(/[&<>"']/g, (m) => map[m]);
};

// åå–®è§£æ (ç¶­æŒä¸è®Š)
const parseRosterInput = (rawText) => {
    if (!rawText) return [];
    const lines = rawText.trim().split('\n');
    return lines.map(line => {
        let parts = line.trim().split(/[\t,]+/); 
        if (parts.length >= 3) {
            const name = parts[0]?.trim(); 
            const id = parts[2]?.trim();   
            if (id === 'ç·¨è™Ÿ' || name === 'å§“å') return null;
            if (!id || !name) return null;
            return { StudentId: sanitize(id), Name: sanitize(name) };
        }
        if (parts.length === 2) {
            const p0 = parts[0]?.trim();
            const p1 = parts[1]?.trim();
            if (/^[S\d]/.test(p0.toUpperCase())) return { StudentId: sanitize(p0), Name: sanitize(p1) };
            else return { StudentId: sanitize(p1), Name: sanitize(p0) };
        }
        return null;
    }).filter(x => x !== null);
};

const generateSessionId = () => `${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}-${Math.random().toString(36).substring(2,6).toUpperCase()}`;

function useAuth(addToast) {
    const isLogin = ref(false);
    const performLogin = async (password) => {
        try {
            await signInWithEmailAndPassword(auth, "admin@zodiac.com", password);
        } catch (e) {
            let msg = "ç™»å…¥å¤±æ•—";
            if (e.code === 'auth/invalid-credential') msg = "å¯†ç¢¼éŒ¯èª¤";
            addToast(msg, 'error', 'fa-solid fa-triangle-exclamation');
        }
    };
    onMounted(() => {
        onAuthStateChanged(auth, (u) => {
            isLogin.value = !!u;
            if (u) addToast("ç³»çµ±åˆå§‹åŒ–å®Œæˆ", 'success', 'fa-solid fa-check-circle');
        });
    });
    return { isLogin, performLogin, logout: () => signOut(auth) };
}

function useRoom(sessionId, addToast) {
    // [Updated] ç‹€æ…‹çµæ§‹ç¾åœ¨åŒ…å« config
    const status = reactive({ 
        loginStatus: 'open', 
        phaseA: 'waiting', 
        phaseB: 'waiting', 
        config: { enableGroupA: true, enableGroupB: true, assignmentType: 'individual' },
        links: {} 
    });
    const schedule = reactive({ enabled: false, openAt: '', closeAt: '' });
    const students = ref({}); 
    const isConnected = ref(true);

    const initStatusListener = () => {
        const statusRef = dbRef(db, `classrooms/${sessionId.value}/status`);
        onValue(statusRef, (snap) => {
            const val = snap.val();
            if (val) {
                Object.assign(status, val);
                // é˜²å‘†: ç¢ºä¿ config ç‰©ä»¶å­˜åœ¨
                if(!status.config) status.config = { enableGroupA: true, enableGroupB: true, assignmentType: 'individual' };
                if (val.schedule) Object.assign(schedule, val.schedule);
            }
        });
    };

    const initStudentListener = () => {
        const studentRef = dbRef(db, `classrooms/${sessionId.value}/students`);
        onValue(studentRef, (snap) => {
            students.value = snap.val() || {};
        });
    };

    const initConnectionMonitor = () => {
        const connectedRef = dbRef(db, ".info/connected");
        onValue(connectedRef, (snap) => {
            isConnected.value = snap.val() === true;
            if (snap.val() === false) addToast("ç¶²è·¯è¨Šè™Ÿä¸­æ–·", 'error', 'fa-solid fa-wifi');
        });
    };

    onMounted(() => initConnectionMonitor());

    return { status, schedule, students, initStatusListener, initStudentListener };
}

function useArchiver(sessionId, students, addToast) {
    const isSyncing = ref(false);

    const syncToSheets = async () => {
        if (!CONFIG.GAS_URL) { addToast("å°šæœªè¨­å®š GAS ç¶²å€", "error", "fa-solid fa-xmark"); return; }
        const count = Object.keys(students.value || {}).length;
        if (count === 0 && !confirm("ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œç¢ºå®šè¦å­˜æª”å—ï¼Ÿ")) return;
        
        isSyncing.value = true;
        addToast("æ­£åœ¨é€£ç·šåˆ° Google Sheet...", "info", "fa-solid fa-cloud-arrow-up");

        try {
            // [Updated] å‚³é€æ›´å®Œæ•´çš„è³‡æ–™çµæ§‹çµ¦ GAS
            const payload = {
                sessionId: sessionId.value,
                students: students.value, // GAS ç«¯æœƒè² è²¬è§£ææ–°çš„åˆ†æ•¸çµæ§‹
                timestamp: Date.now()
            };

            const response = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });

            const res = await response.json();
            
            if (res.status === 'success') {
                addToast("å­˜æª”æˆåŠŸ", "success", "fa-solid fa-check");
            } else {
                throw new Error(res.message);
            }
        } catch (e) {
            console.error(e);
            addToast("å­˜æª”å¤±æ•—: " + e.message, "error", "fa-solid fa-triangle-exclamation");
        } finally {
            isSyncing.value = false;
        }
    };

    return { isSyncing, syncToSheets };
}

function useHistory() {
    const sessionHistory = ref([]);
    const showHistory = ref(false);
    const manualSessionId = ref('');
    const latestSessionId = ref('');

    const loadHistory = () => {
        const stored = localStorage.getItem('zodiac_history');
        if (stored) {
            try { 
                sessionHistory.value = JSON.parse(stored); 
                if (sessionHistory.value.length > 0) latestSessionId.value = sessionHistory.value[0].id;
            } catch(e) {}
        }
        const storedLatest = localStorage.getItem('zodiac_latest_session_id');
        if(storedLatest) latestSessionId.value = storedLatest;
    };

    const addToHistory = (id) => {
        if (!id) return;
        latestSessionId.value = id;
        localStorage.setItem('zodiac_latest_session_id', id);

        const exists = sessionHistory.value.find(h => h.id === id);
        if (exists) return;

        sessionHistory.value.unshift({
            id: id,
            date: new Date().toLocaleDateString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' })
        });
        
        if (sessionHistory.value.length > 10) sessionHistory.value.pop();
        localStorage.setItem('zodiac_history', JSON.stringify(sessionHistory.value));
    };

    const switchSession = (id) => {
        if(!id) return;
        if(confirm(`ç¢ºå®šè¦åˆ‡æ›åˆ°èª²å ‚ [${id}] å—ï¼Ÿ`)) {
            localStorage.setItem('zodiac_last_session', id);
            const url = new URL(window.location);
            url.searchParams.set('id', id); 
            window.location.search = `?id=${id}`;
        }
    };

    return { sessionHistory, showHistory, manualSessionId, latestSessionId, loadHistory, addToHistory, switchSession };
}

function useMigration(students, addToast, addToHistory) {
    const isMigrating = ref(false);

    const cloneToNewSession = async () => {
        const count = Object.keys(students.value || {}).length;
        if (count === 0) { addToast("æ²’æœ‰å­¸ç”Ÿè³‡æ–™å¯ä¾›è¤‡è£½", "error"); return; }
        
        if (!confirm(`ã€æº–å‚™å»ºç«‹æ–°èª²å ‚ã€‘\n\nç³»çµ±å°‡æœƒï¼š\n1. ç”¢ç”Ÿä¸€çµ„å…¨æ–°çš„ Session ID\n2. è¤‡è£½é€™ ${count} ä½å­¸ç”Ÿçš„åå–®èˆ‡ç¶å®šè³‡è¨Š\n3. é‡ç½®æ‰€æœ‰äººçš„åˆ†æ•¸èˆ‡é€²åº¦\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) return;

        isMigrating.value = true;
        const newSessionId = generateSessionId(); 
        const updates = {};

        try {
            updates[`classrooms/${newSessionId}/status`] = { 
                loginStatus: 'open', 
                phaseA: 'waiting', 
                phaseB: 'waiting',
                config: { enableGroupA: true, enableGroupB: true, assignmentType: 'individual' },
                links: { notebook:'', slido:'', forms:'' } 
            };

            Object.entries(students.value).forEach(([uid, s]) => {
                updates[`classrooms/${newSessionId}/students/${uid}/profile`] = s.profile;
                if (s.auth) {
                    updates[`classrooms/${newSessionId}/students/${uid}/auth`] = { ...s.auth, isActive: false };
                } else {
                    updates[`classrooms/${newSessionId}/students/${uid}/auth`] = { isActive: false };
                }
                updates[`classrooms/${newSessionId}/students/${uid}/status`] = 'offline';
                updates[`classrooms/${newSessionId}/students/${uid}/lastSeen`] = 0; 
            });

            await update(dbRef(db), updates);
            addToHistory(newSessionId);

            if(confirm(`æ–°èª²å ‚ [${newSessionId}] å»ºç«‹æˆåŠŸï¼\n\næ˜¯å¦ç«‹å³åˆ‡æ›éå»ï¼Ÿ`)) {
                localStorage.setItem('zodiac_last_session', newSessionId); 
                window.location.search = `?id=${newSessionId}`;
            }

        } catch(e) {
            console.error(e);
            addToast("å»ºç«‹å¤±æ•—: " + e.message, "error");
        } finally {
            isMigrating.value = false;
        }
    };

    return { isMigrating, cloneToNewSession };
}

createApp({
    setup() {
        const form = reactive({ sessionId: generateSessionId(), password: '' });
        const toasts = reactive([]); 
        const showImporter = ref(false);
        const searchQuery = ref('');

        const addToast = (msg, type = 'info', icon = 'fa-solid fa-circle-info') => {
            const id = Date.now() + Math.random();
            toasts.push({ id, msg, type, icon });
            // Auto-remove after 3 seconds
            setTimeout(() => {
                const idx = toasts.findIndex(t => t.id === id);
                if (idx > -1) toasts.splice(idx, 1);
            }, 3000);
        };

        const { isLogin, performLogin, logout } = useAuth(addToast);
        const sessionIdRef = computed(() => form.sessionId);
        const { status, schedule, students, initStatusListener, initStudentListener } = useRoom(sessionIdRef, addToast);
        const { isSyncing, syncToSheets } = useArchiver(sessionIdRef, students, addToast);
        const { sessionHistory, showHistory, manualSessionId, latestSessionId, loadHistory, addToHistory, switchSession } = useHistory();
        const { isMigrating, cloneToNewSession } = useMigration(students, addToast, addToHistory);

        onMounted(() => {
            loadHistory();
            const urlId = new URLSearchParams(window.location.search).get('id');
            const savedId = localStorage.getItem('zodiac_last_session');
            if (urlId) form.sessionId = urlId;
            else if (savedId) form.sessionId = savedId;

            if (!latestSessionId.value && form.sessionId) {
                latestSessionId.value = form.sessionId;
                localStorage.setItem('zodiac_latest_session_id', form.sessionId);
            }

            setInterval(() => { 
                if (isLogin.value && schedule.enabled) {
                    const nowStr = new Date().toTimeString().slice(0,5);
                    if (nowStr === schedule.openAt && status.loginStatus !== 'open') updateStatus('open');
                    if (nowStr === schedule.closeAt && status.loginStatus !== 'locked') updateStatus('locked');
                }
            }, 1000);
        });

        watch(isLogin, (val) => {
            if (val) {
                localStorage.setItem('zodiac_last_session', form.sessionId);
                addToHistory(form.sessionId); 
                initStatusListener();
                initStudentListener();
            }
        });

        const updateStatus = (s) => update(dbRef(db, `classrooms/${form.sessionId}/status`), { loginStatus: s });
        
        // [New] Config Updater
        const updateConfig = (key, value) => {
            // Fix: update() requires an object, set() is used for specific value replacement
            set(dbRef(db, `classrooms/${form.sessionId}/status/config/${key}`), value);
        };

        // [Updated] Switch Phase with Group Support
        const switchPhase = async (p, group) => {
            const updates = {};
            const oldPhase = group === 'A' ? status.phaseA : status.phaseB;
            // Optimistic UI
            if (group === 'A') status.phaseA = p;
            if (group === 'B') status.phaseB = p;

            try {
                if (group === 'A') updates.phaseA = p;
                if (group === 'B') updates.phaseB = p;
                updates.phaseUpdatedAt = Date.now();
                await update(dbRef(db, `classrooms/${form.sessionId}/status`), updates);
                const label = CONFIG.PHASES[p]?.shortLabel || p;
                addToast(`Group ${group} Set: ${label}`, 'success', 'fa-solid fa-bullhorn');
            } catch (e) {
                console.error("Firebase update failed:", e);
                // Rollback
                if (group === 'A') status.phaseA = oldPhase;
                if (group === 'B') status.phaseB = oldPhase;
                addToast("æ›´æ–°å¤±æ•—", "error", "fa-solid fa-triangle-exclamation");
            }
        };
        
        const saveSchedule = () => update(dbRef(db, `classrooms/${form.sessionId}/status/schedule`), schedule);
        const refreshId = () => form.sessionId = generateSessionId();
        
        const localLinks = reactive({ notebook: '', slido: '', forms: '', assignment: '', gallery: '' });
        const linksDirty = ref(false);
        watch(() => status.links, (newVal) => { if (!linksDirty.value && newVal) Object.assign(localLinks, newVal); }, { deep: true });
        const syncLinks = () => update(dbRef(db, `classrooms/${form.sessionId}/status/links`), localLinks).then(() => { 
            addToast("é€£çµèˆ‡è¨­å®šå·²å„²å­˜", "success", "fa-solid fa-link"); 
            linksDirty.value = false; 
        });

        const importRaw = ref(''), importMode = ref('append'), parsedPreview = ref([]);
        const parseInput = () => {
            const data = parseRosterInput(importRaw.value);
            parsedPreview.value = data.map(s => {
                const uid = s.StudentId.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                return { id: s.StudentId, name: s.Name, exists: !!students.value[uid] };
            });
        };
        const executeImport = async () => {
            if(importMode.value === 'overwrite' && !confirm("è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤ç›®å‰ [æ‰€æœ‰å­¸ç”Ÿ] çš„æˆç¸¾èˆ‡é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            if(importMode.value === 'sync' && !confirm("ç¢ºèªåŸ·è¡Œ [åå–®æ ¡æ­£]ï¼Ÿ\n\nç³»çµ±å°‡æœƒï¼š\n1. ä¿ç•™åå–®å…§å­¸ç”Ÿçš„æˆç¸¾\n2. åˆªé™¤ä¸åœ¨åå–®å…§çš„å­¸ç”Ÿ (é€€é¸è€…)\n3. æ–°å¢åå–®å…§ç¼ºå°‘çš„æ–°ç”Ÿ")) return;

            const updates = {};
            const inputData = parsedPreview.value; 
            const currentDB = students.value || {}; 

            if(importMode.value === 'overwrite') {
                await set(dbRef(db, `classrooms/${form.sessionId}/students`), null);
            }

            if(importMode.value === 'sync') {
                const inputIds = new Set(inputData.map(s => s.id.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase()));
                Object.entries(currentDB).forEach(([uid, student]) => {
                    const dbId = (student.profile?.StudentId || '').trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    if(!inputIds.has(dbId)) {
                        updates[`classrooms/${form.sessionId}/students/${uid}`] = null;
                    }
                });
            }

            inputData.forEach(s => {
                const uid = s.id.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                const exists = !!currentDB[uid];
                if(importMode.value === 'append' && exists) return;
                if(importMode.value === 'sync' && exists) return;
                const z = CONFIG.ZODIAC[Math.floor(Math.random()*12)].label;
                updates[`classrooms/${form.sessionId}/students/${uid}/profile`] = { StudentId: s.id, Name: s.name, Zodiac: z };
                if(!exists) updates[`classrooms/${form.sessionId}/students/${uid}/auth`] = { isActive: false };
            });

            if(Object.keys(updates).length > 0) {
                await update(dbRef(db), updates);
                let msg = importMode.value === 'sync' ? "åå–®æ ¡æ­£å®Œæˆ" : "æˆåŠŸåŒ¯å…¥è³‡æ–™";
                addToast(msg, "success", "fa-solid fa-file-import");
                showImporter.value = false; importRaw.value = ''; parsedPreview.value = [];
            } else {
                addToast("ç„¡éœ€è®Šæ›´", "info", "fa-solid fa-check");
            }
        };
        const generateDemoRoster = () => { importRaw.value = CONFIG.ZODIAC.map((z, i) => `S11${String(i+1).padStart(2,'0')}\tå­¸å“¡ ${z.label}`).join('\n'); parseInput(); };

        const allStudents = computed(() => Object.entries(students.value || {}).map(([uid, data]) => ({ uid, ...data })));
        const displayedList = computed(() => {
            const q = searchQuery.value.toLowerCase();
            return allStudents.value
                .filter(s => (s.profile?.Name || '').toLowerCase().includes(q) || (s.profile?.StudentId || '').includes(q.toUpperCase()))
                .sort((a,b) => (a.profile?.StudentId || '').localeCompare(b.profile?.StudentId || ''))
                .map((s, index) => ({ ...s, rank: index + 1 }));
        });
        const activeCount = computed(() => allStudents.value.filter(s => s.auth?.isActive).length);
        const stats = computed(() => { 
            const list = displayedList.value;
            const calibration = list.filter(s => s.tasks?.calibration?.done).length;
            const notebook = list.filter(s => s.tasks?.notebook?.done).length; 
            const slido = list.filter(s => s.tasks?.slido?.done).length; 
            const forms = list.filter(s => s.tasks?.forms?.done).length; 
            const assignment = list.filter(s => s.tasks?.assignment?.done).length;
            const debrief = list.filter(s => s.rating > 0).length;
            return { calibration, notebook, slido, forms, assignment, debrief, totalDone: calibration + notebook + slido + forms + assignment + debrief }; 
        });
        const globalProgress = computed(() => activeCount.value === 0 ? 0 : (stats.value.totalDone / (activeCount.value * 6)) * 100);

        const copyLink = () => navigator.clipboard.writeText(`${window.location.origin}/index.html?id=${form.sessionId}`).then(()=>addToast("é€£çµå·²è¤‡è£½", "success", "fa-solid fa-copy"));
        const copySessionId = () => navigator.clipboard.writeText(form.sessionId).then(()=>addToast("æ•™å®¤ä»£ç¢¼ (Session ID) å·²è¤‡è£½", "success", "fa-solid fa-key"));
        const qrCodeUrl = computed(() => `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.origin + '/index.html?id=' + form.sessionId)}`);
        const getBeaconClass = (s) => { if (!s.profile?.Zodiac) return ''; const z = CONFIG.ZODIAC.find(x => x.label === s.profile.Zodiac); return z ? `elm-${z.element}` : ''; };
        const getStatusColor = (s) => { 
            if(!s.auth?.isActive) return 'status-offline'; 
            if(s.status === 'offline' || (Date.now() - (s.lastSeen || 0) > 90000)) return 'status-offline'; 
            if(s.status === 'late') return 'status-late'; 
            return 'status-online'; 
        };
        
        // [Updated] v4.38 Scoring Logic (Strict)
        const calculateScore = (student) => { 
            let score = 0; const t = student.tasks || {}; 
            
            // Group A (70%)
            if (t.calibration?.done) score += 5;
            if (t.notebook?.done) { const d = t.notebook.duration || 0; score += (d < 15 ? 5 : 15); }
            if (t.slido?.done) { const d = t.slido.duration || 0; score += (d < 5 ? 5 : 15); }
            if (t.forms?.done) { const d = t.forms.duration || 0; score += (d < 20 ? 10 : 25); }
            if (student.rating > 0) score += 10; // Debrief is now Group A

            // Group B (30%)
            if (t.assignment?.done) score += 15;
            if (t.gallery?.done) score += 15; // Gallery is independent
            
            return score; 
        };

        const isSpeedrun = (s) => { const t = s.tasks||{}; return (t.notebook?.done && (t.notebook.duration||0)<15) || (t.slido?.done && (t.slido.duration||0)<5) || (t.forms?.done && (t.forms.duration||0)<20); };
        
        const revokeToken = (uid, name) => { if(confirm(`ç¢ºå®šè¦å¼·åˆ¶ç™»å‡º ${name} å—ï¼Ÿ`)) { update(dbRef(db, `classrooms/${form.sessionId}/students/${uid}/auth`), { isActive: false, token: null }); update(dbRef(db, `classrooms/${form.sessionId}/students/${uid}`), { status: 'offline' }); addToast("å·²å¼·åˆ¶ç™»å‡ºè©²å­¸ç”Ÿ", "success", "fa-solid fa-link-slash"); } };
        const deleteStudent = (uid, name) => { if(confirm(`å±éšªï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ${name} å—ï¼Ÿ`)) { remove(dbRef(db, `classrooms/${form.sessionId}/students/${uid}`)); addToast("å­¸ç”Ÿè³‡æ–™å·²åˆªé™¤", "success", "fa-solid fa-trash"); } };

        return { 
            form, state: status, schedule, localLinks, linksDirty, toasts, showImporter, importRaw, importMode, parsedPreview, searchQuery,
            hasJoined: isLogin, displayedList, studentCount: computed(() => allStudents.value.length), activeCount, stats, globalProgress, phases: CONFIG.PHASES, qrCodeUrl,
            login: () => performLogin(form.password), logout, 
            setStatus: updateStatus, switchPhase, updateConfig, saveSchedule, refreshId, copyLink, copySessionId, syncLinks,
            parseInput, generateDemoRoster, executeImport,
            getStatusColor, calculateScore, isSpeedrun, getBeaconClass, revokeToken, deleteStudent,
            syncToSheets, isSyncing, cloneToNewSession, isMigrating,
            sessionHistory, showHistory, manualSessionId, switchSession,
            isLatestSession: computed(() => form.sessionId === latestSessionId.value)
        };
    }
}).mount('#app');
</script>
</body>

</html>
